const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/PlatformAdminStatistics-CEbH5UJR.js","assets/index-BsXkJmm5.js","assets/index-CZOqOXoa.css","assets/_plugin-vue_export-helper-DlAUqK2U.js","assets/installCanvasRenderer-CdsqtIo3.js","assets/install-Bmjs6081.js","assets/PlatformAdminStatistics-CBUvP2X_.css","assets/TenantAdminStatistics-BAOqGY_y.js","assets/TenantAdminStatistics-BJuxw6p_.css","assets/UserKnowledgeStatistics-DLO5akhi.js","assets/UserKnowledgeStatistics-CPmG3mtp.css"])))=>i.map(i=>d[i]);
import{e as g,d as Q,A as L,q as K,s as j,b as J,N as V,u as q,r as A,c as y,o as v,f as e,a as o,D as F,w as d,F as z,v as H,K as U,g as _,O as G,l as X,i as w,P as Y,Q as Z,H as ee,R as te,S as se,C as O,T as W,E as S,_ as x}from"./index-BsXkJmm5.js";import{g as ae,a as oe}from"./ticket-DpnOeZSH.js";import{_ as ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ce={TICKET_CREATED:"ticket:created",TICKET_UPDATED:"ticket:updated",TICKET_COMPLETED:"ticket:completed"},B={PLATFORM_ADMIN:"PLATFORM_ADMIN",TENANT_SUPER_ADMIN:"TENANT_SUPER_ADMIN",TENANT_USER:"TENANT_USER"};function ie($="ws://localhost:8081"){const i=g(null),T=g(!1),h=g(null),f=g(0),k=g(null),r=Q({list:[],unreadCount:0,groupedNotifications:L(()=>r.list.reduce((t,s)=>{const n=s.type||"other";return t[n]||(t[n]=[]),t[n].push(s),t},{}))});function p(){const t=J();try{const s=b($,t);console.log("WebSocket 连接URL:",s),i.value=new WebSocket(s),i.value.onopen=()=>{T.value=!0,h.value=null,f.value=0,console.log("WebSocket 连接成功"),E(t),V.success({title:"网络连接",message:"WebSocket 连接已建立"})},i.value.onmessage=n=>{try{const m=JSON.parse(n.data);P(m)}catch(m){console.error("解析WebSocket消息失败:",m)}},i.value.onerror=n=>{h.value=n,T.value=!1,console.error("WebSocket 连接错误:",n)},i.value.onclose=n=>{T.value=!1,console.log("WebSocket 断开连接:",n.code,n.reason),n.code!==1e3&&f.value<5&&D()}}catch(s){h.value=s,console.error("创建 WebSocket 失败:",s)}}function b(t,s){const n=new URL(t);return n.searchParams.set("token",s.token||""),n.searchParams.set("userId",s.user?.username||""),n.searchParams.set("role",I(s)),n.searchParams.set("tenantId",s.tenant?.id||""),n.toString()}function E(t){if(i.value&&i.value.readyState===WebSocket.OPEN){const s={type:"auth",data:M(t)};i.value.send(JSON.stringify(s))}}function P(t){switch(t.type){case"ticket_notification":C(t.data);break;default:console.log("未知消息类型:",t.type)}}function C(t){const s={id:t.id||Date.now(),userName:t.userName||"",feedbackType:t.feedbackType||"工单通知",knowledgeBaseName:t.knowledgeBaseName||"",createdAt:t.createdAt||new Date().toISOString()};r.list.unshift(s),r.unreadCount++,V({title:s.feedbackType,message:`知识库「${s.knowledgeBaseName}」收到新工单`,type:"info",onClick:()=>{c(s.id)}})}function D(){k.value&&clearTimeout(k.value),f.value++;const t=Math.min(1e3*Math.pow(2,f.value),3e4);k.value=setTimeout(()=>{console.log(`WebSocket 重连尝试 ${f.value}`),p()},t)}function M(t){return{token:t.token||"",userId:t.user?.username||"",role:I(t),tenantId:t.tenant?.id||""}}function I(t){return t.isPlatformAdmin?B.PLATFORM_ADMIN:t.isTenantSuperAdmin?B.TENANT_SUPER_ADMIN:B.TENANT_USER}function R(t,s){if(i.value&&i.value.readyState===WebSocket.OPEN){const n={type:t,data:s,timestamp:Date.now()};i.value.send(JSON.stringify(n))}}function c(t){r.unreadCount>0&&r.unreadCount--}function a(t){r.list=r.list.filter(s=>s.type!==t),r.unreadCount=r.list.length}function l(){r.list=[],r.unreadCount=0}function u(){i.value&&i.value.readyState===WebSocket.OPEN||p()}function N(){i.value&&i.value.close(1e3,"Manual disconnect"),k.value&&(clearTimeout(k.value),k.value=null)}return K(()=>{setTimeout(p,1e3)}),j(()=>{N()}),{socket:i,isConnected:T,notifications:r,error:h,reconnectAttempts:f,NotificationTypes:ce,UserRoles:B,connect:u,disconnect:N,sendMessage:R,markNotificationAsRead:c,clearNotificationsByType:a,clearAllNotifications:l}}const le={class:"dashboard-container"},de={class:"dashboard-layout"},re={class:"notification-section"},ue={class:"card-header"},_e={key:0,class:"loading-notification"},fe={key:1,class:"empty-notification"},me=["onClick"],ve={class:"notification-content"},ke={class:"notification-title"},pe={class:"notification-detail"},Ne={class:"notification-time"},ge={key:0,class:"stats-cards-container"},Te={class:"stat-card"},he={class:"stat-icon"},Ae={class:"stat-card"},ye={class:"stat-icon"},we={class:"stat-card"},be={class:"stat-icon"},Ee={class:"stat-card"},Se={class:"stat-icon"},Ie={class:"stat-card"},Be={class:"stat-icon"},Pe={class:"stat-card"},Ce={class:"stat-icon"},De={class:"statistics-section"},Me={__name:"Dashboard",setup($){const i=W(()=>x(()=>import("./PlatformAdminStatistics-CEbH5UJR.js"),__vite__mapDeps([0,1,2,3,4,5,6]))),T=W(()=>x(()=>import("./TenantAdminStatistics-BAOqGY_y.js"),__vite__mapDeps([7,1,2,3,4,8]))),h=W(()=>x(()=>import("./UserKnowledgeStatistics-DLO5akhi.js"),__vite__mapDeps([9,1,2,3,4,5,10]))),f=J(),k=q(),{notifications:r}=ie("ws://localhost:8081"),p=g([]),b=g(!1),E=L(()=>{const c=r.list||[],a=p.value||[],l=new Map;return a.forEach(u=>{l.set(u.id,u)}),c.forEach(u=>{l.set(u.id,u)}),Array.from(l.values()).sort((u,N)=>N.timestamp-u.timestamp)}),P=L(()=>E.value.length),C=async()=>{try{b.value=!0;const c=await ae();c?.data&&(p.value=c.data)}catch(c){console.error("加载工单通知失败:",c),S.error("加载工单通知失败")}finally{b.value=!1}},D=async c=>{try{const a=c.id;if(!a){S.warning("工单ID不存在");return}console.log("正在获取工单对应的知识库信息，工单ID:",a);const l=await oe(a);if(console.log("接口返回数据:",l),l?.data?.knowledgeBaseId){const u=l.data.knowledgeBaseId,N=l.data.knowledgeBaseName||"未知知识库";console.log("跳转到知识库:",u,"调优页面"),k.push(`/knowledgebase/${u}?tab=optimize`),S.success(`正在跳转到知识库「${N}」的调优页面`)}else S.warning("未找到对应的知识库信息")}catch(a){console.error("处理工单通知失败:",a),S.error(`处理工单通知失败: ${a.message||"未知错误"}`)}},M=c=>c||"未知时间",I=c=>c.feedbackType||"工单通知",R=c=>{const a=[];return c.userName&&a.push(`用户：${c.userName}`),c.knowledgeBaseName&&a.push(`知识库：${c.knowledgeBaseName}`),a.join(" | ")};return K(()=>{C(),setTimeout(()=>{p.value.length===0&&(p.value=[{id:1,userName:"张三",feedbackType:"文档更新",knowledgeBaseName:"技术文档库",createdAt:"2024-01-15 14:30:00"},{id:2,userName:"李四",feedbackType:"内容审核",knowledgeBaseName:"产品手册库",createdAt:"2024-01-15 13:15:00"},{id:4,userName:"赵六",feedbackType:"错误修复",knowledgeBaseName:"用户指南库",createdAt:"2024-01-15 11:45:00"},{id:5,userName:"钱七",feedbackType:"内容优化",knowledgeBaseName:"FAQ知识库",createdAt:"2024-01-15 10:30:00"},{id:7,userName:"周九",feedbackType:"功能需求",knowledgeBaseName:"开发文档库",createdAt:"2024-01-15 09:45:00"},{id:8,userName:"吴十",feedbackType:"Bug修复",knowledgeBaseName:"测试文档库",createdAt:"2024-01-15 08:30:00"},{id:9,userName:"郑十一",feedbackType:"内容补充",knowledgeBaseName:"用户手册库",createdAt:"2024-01-15 07:15:00"}])},1e3)}),(c,a)=>{const l=A("el-icon"),u=A("el-badge"),N=A("el-scrollbar"),t=A("el-card"),s=A("el-col"),n=A("el-row");return v(),y("div",le,[e("div",de,[e("div",re,[o(t,{shadow:"hover",class:"notification-card"},{header:d(()=>[e("div",ue,[a[0]||(a[0]=e("span",null,"工单通知",-1)),o(u,{value:P.value,max:99,class:"unread-badge"},{default:d(()=>[o(l,null,{default:d(()=>[o(_(G))]),_:1})]),_:1},8,["value"])])]),default:d(()=>[o(N,{class:"notification-list"},{default:d(()=>[b.value?(v(),y("div",_e,"加载中...")):E.value.length===0?(v(),y("div",fe,"暂无工单通知")):F("",!0),(v(!0),y(z,null,H(E.value,m=>(v(),y("div",{key:m.id,class:"notification-item",onClick:Re=>D(m)},[e("div",ve,[e("div",ke,[e("span",null,U(I(m)),1)]),e("div",pe,U(R(m)),1),e("div",Ne,U(M(m.createdAt)),1)])],8,me))),128))]),_:1})]),_:1}),_(f).isPlatformAdmin?(v(),y("div",ge,[o(n,{gutter:12,class:"stats-row"},{default:d(()=>[o(s,{xs:12,sm:12,md:6,lg:6},{default:d(()=>[e("div",Te,[e("div",he,[o(l,null,{default:d(()=>[o(_(X))]),_:1})]),a[1]||(a[1]=e("div",{class:"stat-content"},[e("div",{class:"stat-title"},"登录失败统计"),e("div",{class:"stat-value"},[w("9"),e("span",{class:"stat-unit"},"次")]),e("div",{class:"stat-desc"},"近24h失败数")],-1))])]),_:1}),o(s,{xs:12,sm:12,md:6,lg:6},{default:d(()=>[e("div",Ae,[e("div",ye,[o(l,null,{default:d(()=>[o(_(Y))]),_:1})]),a[2]||(a[2]=e("div",{class:"stat-content"},[e("div",{class:"stat-title"},"API异常率"),e("div",{class:"stat-value"},[w("2"),e("span",{class:"stat-unit"},"%")]),e("div",{class:"stat-desc"},"跨租户占比")],-1))])]),_:1}),o(s,{xs:12,sm:12,md:6,lg:6},{default:d(()=>[e("div",we,[e("div",be,[o(l,null,{default:d(()=>[o(_(Z))]),_:1})]),a[3]||(a[3]=e("div",{class:"stat-content"},[e("div",{class:"stat-title"},"存储使用"),e("div",{class:"stat-value"},[w("2.3"),e("span",{class:"stat-unit"},"TB")]),e("div",{class:"stat-desc"},"平台总存储量")],-1))])]),_:1}),o(s,{xs:12,sm:12,md:6,lg:6},{default:d(()=>[e("div",Ee,[e("div",Se,[o(l,null,{default:d(()=>[o(_(ee))]),_:1})]),a[4]||(a[4]=e("div",{class:"stat-content"},[e("div",{class:"stat-title"},"文档条目"),e("div",{class:"stat-value"},[w("1200"),e("span",{class:"stat-unit"},"条")]),e("div",{class:"stat-desc"},"全平台总量")],-1))])]),_:1}),o(s,{xs:12,sm:12,md:6,lg:6},{default:d(()=>[e("div",Ie,[e("div",Be,[o(l,null,{default:d(()=>[o(_(te))]),_:1})]),a[5]||(a[5]=e("div",{class:"stat-content"},[e("div",{class:"stat-title"},"系统告警"),e("div",{class:"stat-value"},[w("3"),e("span",{class:"stat-unit"},"条")]),e("div",{class:"stat-desc"},"待处理告警")],-1))])]),_:1}),o(s,{xs:12,sm:12,md:6,lg:6},{default:d(()=>[e("div",Pe,[e("div",Ce,[o(l,null,{default:d(()=>[o(_(se))]),_:1})]),a[6]||(a[6]=e("div",{class:"stat-content"},[e("div",{class:"stat-title"},"系统响应时间"),e("div",{class:"stat-value"},[w("156"),e("span",{class:"stat-unit"},"ms")]),e("div",{class:"stat-desc"},"平均响应时间")],-1))])]),_:1})]),_:1})])):F("",!0)]),e("div",De,[_(f).isPlatformAdmin?(v(),O(_(i),{key:0})):_(f).isTenantSuperAdmin?(v(),O(_(T),{key:1})):(v(),O(_(h),{key:2}))])])])}}},xe=ne(Me,[["__scopeId","data-v-f47f2191"]]);export{xe as default};
