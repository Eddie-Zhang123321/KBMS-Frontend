import{Y as we,e as y,d as de,r as B,p as R,o as h,w as s,a,c as W,F as H,C as J,f as I,i as g,a5 as he,E as c,m as ie,q as Y,M as ee,g as l,a6 as Ce,B as K,a7 as xe,n as Se,z as Ve,Q as Ue,K as ke,a8 as M,a9 as ne,aa as De,ab as Ie,ac as Ee,ad as $e,G as Ae,ae as X,af as oe,ag as Z,ah as F,ai as j,aj as Ne,ak as O,al as re,am as Re,an as Be,N as Q,ao as Le,ap as ue,aq as ze}from"./index-CxOdaYXd.js";import{_ as ae}from"./_plugin-vue_export-helper-DlAUqK2U.js";const me=()=>we("/departments"),je={class:"dialog-footer"},Te={__name:"CreateUser",emits:["user-created"],setup(le,{expose:P,emit:L}){const v=L,w=y(!1),m=de({userName:"",email:"",tenantSuperAdmin:!1,password:"",department:""}),z=[{label:"普通用户",value:!1},{label:"超级管理员",value:!0}],_=y([]),S={userName:[{required:!0,message:"请输入用户名称",trigger:"blur"},{min:2,max:20,message:"长度在 2 到 20 个字符",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],tenantSuperAdmin:[{required:!0,message:"请选择角色",trigger:"change"}],password:[{required:!0,message:"请输入默认密码",trigger:"blur"},{min:6,max:20,message:"长度在 6 到 20 个字符",trigger:"blur"}],department:[{required:!0,message:"请选择部门",trigger:"change"},{validator:(d,r,x)=>{r?_.value.some(E=>E.name===r)?x():x(new Error("请选择有效的部门")):x(new Error("请选择部门"))},trigger:"change"}]},u=y(null),V=async()=>{try{const d=await me();console.log("部门数据响应:",d),d&&d.data&&d.data.items?_.value=d.data.items.map(r=>({id:r.id,name:r.name})):d&&d.items?_.value=d.items.map(r=>({id:r.id,name:r.name})):Array.isArray(d)?_.value=d.map(r=>({id:r.id,name:r.name})):(console.warn("部门数据解析失败，响应格式:",d),_.value=[]),console.log("部门选项:",_.value)}catch(d){console.error("获取部门数据失败",d),c.error("获取部门数据失败: "+(d.message||"未知错误")),_.value=[]}},q=()=>{w.value=!0,V()},C=()=>{u.value?.resetFields(),w.value=!1},b=async()=>{try{await u.value.validate(),console.log("创建用户数据:",m);const d=await he(m);console.log("创建用户响应:",d),c.success("用户创建成功"),v("user-created",d?.data||d),C()}catch(d){console.error("创建用户失败:",d),c.error("创建用户失败: "+(d.message||"未知错误"))}};return P({open:q}),(d,r)=>{const x=B("el-input"),E=B("el-form-item"),f=B("el-option"),o=B("el-select"),k=B("el-form"),$=B("el-button"),A=B("el-dialog");return h(),R(A,{modelValue:w.value,"onUpdate:modelValue":r[5]||(r[5]=i=>w.value=i),title:"新增用户",width:"500px","before-close":C},{footer:s(()=>[I("span",je,[a($,{onClick:C},{default:s(()=>r[6]||(r[6]=[g("取消")])),_:1,__:[6]}),a($,{type:"primary",onClick:b},{default:s(()=>r[7]||(r[7]=[g("确定")])),_:1,__:[7]})])]),default:s(()=>[a(k,{ref_key:"formRef",ref:u,model:m,rules:S,"label-width":"100px","label-position":"right"},{default:s(()=>[a(E,{label:"用户名称",prop:"userName"},{default:s(()=>[a(x,{modelValue:m.userName,"onUpdate:modelValue":r[0]||(r[0]=i=>m.userName=i),placeholder:"请输入用户名称",clearable:""},null,8,["modelValue"])]),_:1}),a(E,{label:"邮箱",prop:"email"},{default:s(()=>[a(x,{modelValue:m.email,"onUpdate:modelValue":r[1]||(r[1]=i=>m.email=i),placeholder:"请输入邮箱",clearable:""},null,8,["modelValue"])]),_:1}),a(E,{label:"部门",prop:"department"},{default:s(()=>[a(o,{modelValue:m.department,"onUpdate:modelValue":r[2]||(r[2]=i=>m.department=i),placeholder:"请选择部门",style:{width:"100%"},clearable:""},{default:s(()=>[(h(!0),W(H,null,J(_.value,i=>(h(),R(f,{key:i.id,label:i.name,value:i.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(E,{label:"角色",prop:"tenantSuperAdmin"},{default:s(()=>[a(o,{modelValue:m.tenantSuperAdmin,"onUpdate:modelValue":r[3]||(r[3]=i=>m.tenantSuperAdmin=i),placeholder:"请选择角色",style:{width:"100%"}},{default:s(()=>[(h(),W(H,null,J(z,i=>a(f,{key:i.value,label:i.label,value:i.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),a(E,{label:"默认密码",prop:"password"},{default:s(()=>[a(x,{modelValue:m.password,"onUpdate:modelValue":r[4]||(r[4]=i=>m.password=i),placeholder:"请输入默认密码","show-password":"",clearable:""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])}}},Me=ae(Te,[["__scopeId","data-v-d4df5070"]]),Fe={key:0,class:"result-area"},Oe={class:"button-row"},qe={__name:"BatchImport",emits:["import-success"],setup(le,{expose:P}){const L=y(!1),v=y(null),w=y([]),m=y(""),z=de({file:null}),_=ie(()=>{if(w.value.length===0)return!1;const f=w.value[0].raw;return f&&f.size<=5*1024*1024&&S(f.name)}),S=f=>f.toLowerCase().endsWith(".csv"),u=()=>{L.value=!0,w.value=[],m.value=""},V=()=>{w.value=[],m.value="",L.value=!1},q=(f,o)=>{w.value=o,z.file=f.raw},C=()=>{z.file=null,w.value=[]},b=f=>{const o=f.dataTransfer.files[0];o&&S(o.name)&&o.size<=5*1024*1024?(w.value=[{raw:o,name:o.name,status:"ready"}],q({raw:o},w.value)):c.error("请上传有效的 CSV 文件（最大 5MB）")},d=f=>{f.preventDefault()},r=()=>{v.value.$refs.input.click()},x=()=>{const f=["userName","email","department","tenantSuperAdmin","createTime"],o=[["zhangsan","zhangsan@example.com","技术部","false","2024-01-15 14:30:00"],["lisi","lisi@example.com","销售部","true","2024-01-15 15:30:00"],["wangwu","wangwu@example.com","人事部","false","2024-01-15 16:30:00"]],k="\uFEFF"+[f.join(","),...o.map(G=>G.join(","))].join(`
`),$=new Blob([k],{type:"text/csv;charset=utf-8;"}),A=URL.createObjectURL($),i=document.createElement("a");i.href=A,i.download="user_import_template.csv",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(A),c.success("模板下载成功")},E=async()=>{if(!z.file||!_.value){c.warning("请选择一个有效的 CSV 文件（最大 5MB）");return}const f=new FormData;f.append("file",z.file);try{console.log("开始批量导入用户，文件:",z.file.name,"大小:",z.file.size);const o=await xe(f);console.log("批量导入响应:",o);const k=o?.data||o;if(k&&k.importedCount!==void 0){const $=k.importedCount||0;$>0?(m.value=`批量导入成功，新增 ${$} 个用户`,c.success(m.value),emit("import-success"),V()):(m.value="没有成功导入任何用户",c.warning(m.value))}else m.value=`批量导入失败: ${k?.message||"未知错误"}`,c.error(m.value)}catch(o){console.error("上传失败:",o),m.value="上传过程中发生错误，请稍后重试",c.error(m.value)}};return P({open:u}),(f,o)=>{const k=B("el-icon"),$=B("el-upload"),A=B("el-button"),i=B("el-dialog");return h(),R(i,{modelValue:L.value,"onUpdate:modelValue":o[0]||(o[0]=G=>L.value=G),title:"批量导入用户",width:"500px","before-close":V},{default:s(()=>[a($,{ref_key:"uploadRef",ref:v,"auto-upload":!1,"file-list":w.value,limit:1,accept:".csv","on-change":q,"on-remove":C,class:"upload-demo",action:"","on-drop":b,"on-dragover":d},{tip:s(()=>o[4]||(o[4]=[I("div",{class:"el-upload__tip"},[g(" 文件应包含字段：userName, email, department, tenantSuperAdmin, createTime"),I("br"),g(' 注意：id和status字段由系统自动生成，导入的用户默认状态为"开通" ')],-1)])),default:s(()=>[I("div",{class:"drag-area",onDrop:ee(b,["prevent"]),onDragover:ee(d,["prevent"]),onClick:r},[I("div",null,[o[1]||(o[1]=g(" 点击上传 CSV 文件")),a(k,null,{default:s(()=>[a(l(Ce))]),_:1}),o[2]||(o[2]=I("br",null,null,-1)),o[3]||(o[3]=g("仅支持 .csv 格式文件，最大 5MB "))])],32)]),_:1},8,["file-list"]),m.value?(h(),W("div",Fe,K(m.value),1)):Y("",!0),I("div",Oe,[a(A,{onClick:x,class:"upload-template"},{default:s(()=>o[5]||(o[5]=[g("下载模板")])),_:1,__:[5]}),a(A,{onClick:V},{default:s(()=>o[6]||(o[6]=[g("取消")])),_:1,__:[6]}),a(A,{type:"primary",disabled:w.value.length===0||!_.value,onClick:E},{default:s(()=>o[7]||(o[7]=[g("上传")])),_:1,__:[7]},8,["disabled"])])]),_:1},8,["modelValue"])}}},Pe=ae(qe,[["__scopeId","data-v-ea369cf4"]]),We={class:"user-management"},Ge={style:{padding:"40px 0","text-align":"center",color:"#999"}},Ke={style:{"font-size":"12px","margin-top":"8px"}},Qe={__name:"UserList",setup(le){const P=y(),L=y(),v=y({id:"",userName:"",tenantSuperAdmin:null,status:null}),w=()=>{P.value.open()},m=()=>{b.value=1,o(),c.success("新用户已添加到列表中")},z=()=>{L.value?L.value.open():console.error("batchImport ref is not available")},_=y([]),S=y(null),u=y([]),V=y([]),q=y(null),C=y(0),b=y(1),d=y(10),r=y(!1),x=y(!1),E=ie(()=>u.value||[]);Se(b,()=>{o()},{immediate:!1}),Ve(async()=>{await f(),await o()});const f=async()=>{try{const n=await me();n&&n.data&&n.data.items?_.value=n.data.items.map(e=>({id:e.id,name:e.name})):n&&n.items?_.value=n.items.map(e=>({id:e.id,name:e.name})):Array.isArray(n)?_.value=n.map(e=>({id:e.id,name:e.name})):_.value=[]}catch(n){console.error("获取部门数据失败",n),c.error("获取部门数据失败: "+(n.message||"未知错误")),_.value=[]}},o=async()=>{r.value=!0;try{const n={page:b.value,pageSize:d.value,...v.value};if(S.value){const p=_.value.find(t=>t.id.toString()===S.value);p&&(n.department=p.name)}Object.keys(n).forEach(p=>{(n[p]===""||n[p]===null||n[p]===void 0)&&delete n[p]});const e=await Ue(n);e&&e.data&&e.data.items?(u.value=e.data.items,C.value=e.data.total||0):e&&e.items?(u.value=e.items,C.value=e.total||0):Array.isArray(e)?(u.value=e,C.value=e.length):(u.value=[],C.value=0)}catch(n){console.error("获取用户数据失败",n),c.error("获取用户数据失败: "+(n.message||"未知错误")),u.value=[],C.value=0}finally{r.value=!1}},k=n=>{S.value===n?S.value=null:S.value=n,b.value=1,o()},$=()=>{b.value=1,o(),v.value.id&&v.value.id.trim()||v.value.userName&&v.value.userName.trim()||v.value.tenantSuperAdmin!==null&&v.value.tenantSuperAdmin!==void 0||v.value.status!==null&&v.value.status!==void 0||S.value?c.success("筛选完成"):c.info("显示所有用户")},A=()=>{v.value={id:"",userName:"",tenantSuperAdmin:null,status:null},S.value=null,b.value=1,o()},i=n=>{const e=n.status===1?0:1,p=e===1?"开通":"关闭";Q.confirm(`确认${p}用户「${n.userName}」吗？`,"提示",{type:"warning"}).then(async()=>{try{const t=await ue(n.id,{status:e});c.success(`用户已${p}`);const U=t?.data||t;if(U){const D=u.value.findIndex(T=>T.id===n.id);D!==-1&&(u.value[D]={...u.value[D],...U})}else{const D=u.value.findIndex(T=>T.id===n.id);D!==-1&&(u.value[D]={...u.value[D],status:e})}}catch(t){console.error("状态切换失败:",t),c.error(`${p}失败: ${t.message||"未知错误"}`)}}).catch(()=>{})},G=n=>{Q.confirm(`确认审核通过用户「${n.userName}」吗？`,"提示",{type:"warning"}).then(async()=>{try{const e=await ue(n.id,{status:1});c.success("用户审核通过");const p=e?.data||e;if(p){const t=u.value.findIndex(U=>U.id===n.id);t!==-1&&(u.value[t]={...u.value[t],...p})}else{const t=u.value.findIndex(U=>U.id===n.id);t!==-1&&(u.value[t]={...u.value[t],status:1})}}catch(e){console.error("审核失败:",e),c.error(`审核失败: ${e.message||"未知错误"}`)}}).catch(()=>{})},pe=n=>{Q.confirm(`确认删除用户「${n.userName}」吗？`,"提示",{type:"warning"}).then(async()=>{try{await ze(n.id),c.success("已删除");const e=u.value.findIndex(p=>String(p.id)===String(n.id));e!==-1&&(u.value.splice(e,1),C.value=Math.max(0,C.value-1),u.value.length===0&&b.value>1&&(b.value=b.value-1,o()))}catch(e){console.error("删除失败:",e),c.error("删除失败: "+(e.message||"未知错误"))}}).catch(()=>{})},ce=n=>{b.value=n,o()},ve=n=>{V.value=n||[]},fe=async()=>{if(V.value.length===0)return;const n=V.value.map(e=>e.id);try{await Q.confirm(`确认批量删除选中的 ${n.length} 位用户吗？`,"提示",{type:"warning"});const e=await Le(n),p=e?.data||e;if(p&&p.deletedCount!==void 0){const t=p.deletedCount||0,U=p.deletedUserIds||[];t>0?(u.value=u.value.filter(D=>!U.includes(D.id)),C.value=Math.max(0,C.value-t),q.value?.clearSelection(),V.value=[],c.success(`成功删除 ${t} 个用户`),u.value.length===0&&b.value>1&&(b.value=b.value-1,o())):c.warning("没有成功删除任何用户")}else c.error(`批量删除失败: ${p?.message||"未知错误"}`)}catch(e){console.error("批量删除失败:",e),c.error("批量删除失败: "+(e.message||"未知错误"))}},ge=()=>{if(V.value.length===0){c.warning("请先勾选需要导出的用户");return}const n=["用户ID","用户名","角色","部门","邮箱","状态","加入时间"],e=N=>{const te=N==null?"":String(N),ye=/[",\n]/.test(te),se=te.replace(/"/g,'""');return ye?`"${se}"`:se},p=V.value.map(N=>[N.id,N.userName,N.tenantSuperAdmin?"超级管理员":"普通用户",N.department,N.email,N.status===1?"开通":N.status===0?"关闭":"待审核",N.createTime].map(e).join(",")),t="\uFEFF"+[n.join(","),...p].join(`
`),U=new Blob([t],{type:"text/csv;charset=utf-8;"}),D=URL.createObjectURL(U),T=document.createElement("a"),be=new Date().toISOString().replace(/[-:T]/g,"").slice(0,14);T.href=D,T.download=`users_export_${be}.csv`,document.body.appendChild(T),T.click(),document.body.removeChild(T),URL.revokeObjectURL(D)},_e=()=>{x.value=!x.value};return(n,e)=>{const p=ke("loading");return h(),W("div",We,[a(l(X),{gutter:16},{default:s(()=>[a(l(M),{span:x.value?1:4,class:"department-col hidden-sm-and-down"},{default:s(()=>[I("div",{class:"collapse-toggle",onClick:ee(_e,["stop"])},[a(l(ne),null,{default:s(()=>[x.value?(h(),R(l(De),{key:0})):(h(),R(l(Ie),{key:1}))]),_:1})]),x.value?Y("",!0):(h(),R(l(Ee),{key:0,"default-active":S.value,class:"el-menu-vertical-demo",onSelect:k},{default:s(()=>[(h(!0),W(H,null,J(_.value,t=>(h(),R(l($e),{key:t.id,index:t.id.toString()},{default:s(()=>[I("span",null,K(t.name),1)]),_:2},1032,["index"]))),128))]),_:1},8,["default-active"]))]),_:1},8,["span"]),a(l(M),{span:x.value?23:20,xs:24,sm:24,class:"right-panel"},{default:s(()=>[a(l(X),{gutter:16,class:"filter-row"},{default:s(()=>[a(l(M),{span:6,xs:24,sm:12},{default:s(()=>[a(l(oe),{placeholder:"请输入用户ID",modelValue:v.value.id,"onUpdate:modelValue":e[0]||(e[0]=t=>v.value.id=t),clearable:""},null,8,["modelValue"])]),_:1}),a(l(M),{span:6,xs:24,sm:12},{default:s(()=>[a(l(oe),{placeholder:"请输入用户名",modelValue:v.value.userName,"onUpdate:modelValue":e[1]||(e[1]=t=>v.value.userName=t),clearable:""},null,8,["modelValue"])]),_:1}),a(l(M),{span:6,xs:24,sm:12,class:"hidden-md-and-up"},{default:s(()=>[a(l(Z),{modelValue:S.value,"onUpdate:modelValue":e[2]||(e[2]=t=>S.value=t),placeholder:"选择部门",style:{width:"100%"}},{default:s(()=>[a(l(F),{label:"全部部门",value:null}),(h(!0),W(H,null,J(_.value,t=>(h(),R(l(F),{key:t.id,label:t.name,value:t.id.toString()},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(l(M),{span:6,xs:24,sm:12},{default:s(()=>[a(l(Z),{modelValue:v.value.tenantSuperAdmin,"onUpdate:modelValue":e[3]||(e[3]=t=>v.value.tenantSuperAdmin=t),placeholder:"选择角色",style:{width:"100%"}},{default:s(()=>[a(l(F),{label:"全部",value:null}),a(l(F),{label:"超级管理员",value:!0}),a(l(F),{label:"普通用户",value:!1})]),_:1},8,["modelValue"])]),_:1}),a(l(M),{span:6,xs:24,sm:12},{default:s(()=>[a(l(Z),{modelValue:v.value.status,"onUpdate:modelValue":e[4]||(e[4]=t=>v.value.status=t),placeholder:"选择状态",style:{width:"100%"}},{default:s(()=>[a(l(F),{label:"全部",value:null}),a(l(F),{label:"开通",value:1}),a(l(F),{label:"关闭",value:0}),a(l(F),{label:"待审核",value:2})]),_:1},8,["modelValue"])]),_:1}),a(l(M),{span:6,xs:24,sm:12,class:"button-group"},{default:s(()=>[a(l(j),{type:"primary",onClick:$},{default:s(()=>e[6]||(e[6]=[g("查询")])),_:1,__:[6]}),a(l(j),{onClick:A},{default:s(()=>e[7]||(e[7]=[g("重置")])),_:1,__:[7]})]),_:1})]),_:1}),a(l(X),{gutter:16,class:"batch-actions",style:{"margin-top":"20px"}},{default:s(()=>[a(l(M),{span:24},{default:s(()=>[a(l(j),{type:"danger",onClick:w},{default:s(()=>e[8]||(e[8]=[g("新增")])),_:1,__:[8]}),a(Me,{ref_key:"createDialog",ref:P,onUserCreated:m},null,512),a(l(j),{type:"primary",onClick:z},{default:s(()=>e[9]||(e[9]=[g("批量导入")])),_:1,__:[9]}),a(Pe,{ref_key:"batchImport",ref:L,onImportSuccess:o},null,512),a(l(j),{type:"primary",disabled:V.value.length===0,onClick:fe},{default:s(()=>e[10]||(e[10]=[g("批量删除")])),_:1,__:[10]},8,["disabled"]),a(l(j),{type:"primary",disabled:V.value.length===0,onClick:ge},{default:s(()=>e[11]||(e[11]=[g("用户导出")])),_:1,__:[11]},8,["disabled"])]),_:1})]),_:1}),Ae((h(),R(l(Ne),{ref_key:"tableRef",ref:q,data:E.value,style:{width:"100%"},stripe:"",onSelectionChange:ve},{empty:s(()=>[I("div",Ge,[a(l(ne),{style:{"font-size":"48px","margin-bottom":"16px"}},{default:s(()=>[a(l(Re))]),_:1}),e[16]||(e[16]=I("p",null,"暂无数据",-1)),I("p",Ke,[e[15]||(e[15]=g(" 请尝试调整筛选条件或 ")),a(l(j),{link:"",onClick:A},{default:s(()=>e[14]||(e[14]=[g("清除所有筛选")])),_:1,__:[14]})])])]),default:s(()=>[a(l(O),{type:"selection",width:"55"}),a(l(O),{prop:"id",label:"用户ID",width:"80"}),a(l(O),{prop:"userName",label:"用户名"}),a(l(O),{prop:"role",label:"角色",width:"120"},{default:s(({row:t})=>[a(l(re),{type:t.tenantSuperAdmin?"warning":"info"},{default:s(()=>[g(K(t.tenantSuperAdmin?"超级管理员":"普通用户"),1)]),_:2},1032,["type"])]),_:1}),a(l(O),{prop:"department",label:"所属部门","class-name":"hidden-sm-and-down"}),a(l(O),{prop:"email",label:"邮箱","class-name":"hidden-md-and-down"}),a(l(O),{prop:"status",label:"状态",width:"100"},{default:s(({row:t})=>[a(l(re),{type:t.status===1?"success":t.status===0?"danger":"warning"},{default:s(()=>[g(K(t.status===1?"开通":t.status===0?"关闭":"待审核"),1)]),_:2},1032,["type"])]),_:1}),a(l(O),{prop:"createTime",label:"加入时间",width:"160","class-name":"hidden-sm-and-down"}),a(l(O),{label:"操作",width:"200"},{default:s(({row:t})=>[t.status!==2?(h(),R(l(j),{key:0,size:"small",type:"warning",onClick:U=>i(t)},{default:s(()=>[g(K(t.status===1?"关闭":"开通"),1)]),_:2},1032,["onClick"])):Y("",!0),t.status===2?(h(),R(l(j),{key:1,size:"small",type:"primary",onClick:U=>G(t)},{default:s(()=>e[12]||(e[12]=[g(" 审核 ")])),_:2,__:[12]},1032,["onClick"])):Y("",!0),a(l(j),{size:"small",type:"danger",onClick:U=>pe(t)},{default:s(()=>e[13]||(e[13]=[g("删除")])),_:2,__:[13]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[p,r.value]]),a(l(Be),{"current-page":b.value,"onUpdate:currentPage":e[5]||(e[5]=t=>b.value=t),total:C.value,"page-size":d.value,layout:"total, prev, pager, next, jumper",onCurrentChange:ce},null,8,["current-page","total","page-size"])]),_:1},8,["span"])]),_:1})])}}},Je=ae(Qe,[["__scopeId","data-v-0385bc8f"]]);export{Je as default};
