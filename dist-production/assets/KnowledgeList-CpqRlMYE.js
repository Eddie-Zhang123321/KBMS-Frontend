import{e as c,d as ae,r,p as K,o as u,w as s,f as l,a as t,c as f,q as F,G as j,H as N,F as I,C as P,j as oe,B as z,I as X,i as m,J as se,E as h,u as ne,n as ie,z as re,K as de,g as ue,L as ce,M as Z,N as pe}from"./index-CxOdaYXd.js";import{c as me,u as _e,g as ve,a as fe,d as ge}from"./kb-QSai4SNc.js";import{_ as ee}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{c as be}from"./chat-DQiZ0Iaz.js";const we={class:"form-container"},ke={key:0,class:"step-indicator"},ye={class:"cover-section"},he={class:"cover-selection"},Ve=["onClick","aria-label","onKeydown"],Ce=["src","alt"],ze={class:"cover-name"},xe={class:"basic-info-section"},$e={class:"params-section"},Be={class:"params-grid"},Ke={class:"param-item"},Ue={class:"param-item"},Se={class:"param-item full-width"},De={class:"param-item full-width"},Me={class:"dialog-footer"},Ie={class:"action-group"},Le={__name:"CreateKB",emits:["success"],setup(le,{expose:w,emit:V}){const g=c(!1),k=c(!1),_=c(null),y=c(null),i=c(0),b=c(window.innerWidth<=768),x=()=>{b.value=window.innerWidth<=768};window.addEventListener("resize",x);const U=[{id:1,url:"/covers/technology.png",name:"科技"},{id:2,url:"/covers/education.png",name:"教育"},{id:3,url:"/covers/business.png",name:"商业"},{id:4,url:"/covers/design.png",name:"设计"},{id:5,url:"/covers/health.png",name:"健康"},{id:6,url:"/covers/default.png",name:"默认"}],n=ae({name:"",description:"",icon:null,chunk_size:1e3,chunk_overlap:200,separator:`

`,embedding_model:"text2vec-base",access_mode:0,vector_store:"faiss",tags:["金融"]}),C={name:[{required:!0,message:"请输入知识库名称",trigger:"blur"}],icon:[{required:!0,message:"请选择封面",trigger:"change"}],access_mode:[{required:!0,message:"请选择访问模式",trigger:"change"}]},L=a=>{n.icon=a},R=()=>{Object.assign(n,{name:"",description:"",icon:null,chunk_size:1e3,chunk_overlap:200,separator:`

`,embedding_model:"text2vec-base",access_mode:0,vector_store:"faiss",tags:[]})},T=()=>{g.value=!1,i.value=0,R()},W=()=>{i.value===0?_.value.validateField("icon",a=>{a&&i.value++}):i.value===1?_.value.validateField("name",a=>{a&&i.value++}):i.value++},G=()=>{i.value>0&&i.value--},H=()=>{_.value.validate(async a=>{if(a){k.value=!0;try{const e=await me({...n});e?(h.success("知识库创建成功"),g.value=!1,R(),J("success")):h.error(e.message||"创建失败")}catch(e){console.error("创建失败:",e),h.error("创建知识库失败，请重试")}finally{k.value=!1}}})};w({open:()=>{g.value=!0,i.value=0,se(()=>{i.value===1&&y.value&&y.value.focus()})}});const J=V;return(a,e)=>{const v=r("el-form-item"),p=r("el-input"),S=r("el-radio"),O=r("el-radio-group"),$=r("el-option"),E=r("el-select"),D=r("el-input-number"),q=r("el-tooltip"),Q=r("el-form"),B=r("el-button"),A=r("el-dialog");return u(),K(A,{modelValue:g.value,"onUpdate:modelValue":e[8]||(e[8]=o=>g.value=o),title:b.value?"新建":"新建知识库","before-close":T,class:"custom-dialog",width:b.value?"90%":"600px"},{footer:s(()=>[l("div",Me,[l("div",Ie,[i.value>0?(u(),K(B,{key:0,onClick:G},{default:s(()=>e[20]||(e[20]=[m("上一步")])),_:1,__:[20]})):F("",!0),i.value<2?(u(),K(B,{key:1,type:"primary",onClick:W},{default:s(()=>e[21]||(e[21]=[m("下一步")])),_:1,__:[21]})):F("",!0),i.value===2?(u(),K(B,{key:2,type:"primary",loading:k.value,onClick:H},{default:s(()=>[m(z(k.value?"创建中...":"创建知识库"),1)]),_:1},8,["loading"])):F("",!0)]),t(B,{onClick:T},{default:s(()=>e[22]||(e[22]=[m("取消")])),_:1,__:[22]})])]),default:s(()=>[l("div",we,[t(Q,{ref_key:"formRef",ref:_,model:n,rules:C,"label-width":b.value?"70px":"80px"},{default:s(()=>[b.value?(u(),f("div",ke,[l("span",{class:N({active:i.value===0})},"1. 封面",2),l("span",{class:N({active:i.value===1})},"2. 信息",2),l("span",{class:N({active:i.value===2})},"3. 参数",2)])):F("",!0),j(l("div",ye,[e[9]||(e[9]=l("div",{class:"section-title"},[l("span",{class:"title-icon"},"🖼️"),l("span",null,"选择知识库封面")],-1)),t(v,{prop:"icon","error-strategy":"custom"},{default:s(()=>[l("div",he,[(u(),f(I,null,P(U,o=>l("div",{key:o.id,class:N(["cover-item",{selected:n.icon===o.id}]),onClick:d=>L(o.id),role:"button","aria-label":`选择封面 ${o.name}`,tabindex:"0",onKeydown:oe(d=>L(o.id),["enter"])},[l("img",{src:o.url,alt:o.name,class:"cover-image",loading:"lazy"},null,8,Ce),l("div",ze,z(o.name),1)],42,Ve)),64))])]),_:1})],512),[[X,i.value===0]]),j(l("div",xe,[e[12]||(e[12]=l("div",{class:"section-title"},[l("span",{class:"title-icon"},"📝"),l("span",null,"基本信息")],-1)),t(v,{label:"知识库名称",prop:"name"},{default:s(()=>[t(p,{ref_key:"nameInputRef",ref:y,modelValue:n.name,"onUpdate:modelValue":e[0]||(e[0]=o=>n.name=o),placeholder:"请输入知识库名称",size:"default",clearable:"","aria-label":"输入知识库名称"},null,8,["modelValue"])]),_:1}),t(v,{label:"描述信息"},{default:s(()=>[t(p,{modelValue:n.description,"onUpdate:modelValue":e[1]||(e[1]=o=>n.description=o),type:"textarea",rows:b.value?2:3,placeholder:"请输入描述",size:"default",clearable:"","aria-label":"输入描述信息"},null,8,["modelValue","rows"])]),_:1}),t(v,{label:"访问模式",prop:"access_mode"},{default:s(()=>[t(O,{modelValue:n.access_mode,"onUpdate:modelValue":e[2]||(e[2]=o=>n.access_mode=o),size:"default","aria-label":"选择访问模式"},{default:s(()=>[t(S,{label:0},{default:s(()=>e[10]||(e[10]=[m("私有")])),_:1,__:[10]}),t(S,{label:1},{default:s(()=>e[11]||(e[11]=[m("公开")])),_:1,__:[11]})]),_:1},8,["modelValue"])]),_:1}),t(v,{label:"标签"},{default:s(()=>[t(E,{modelValue:n.tags,"onUpdate:modelValue":e[3]||(e[3]=o=>n.tags=o),multiple:"",filterable:"","allow-create":"","default-first-option":"",placeholder:"输入或选择标签",style:{width:"100%"},size:"default",clearable:"","aria-label":"选择或输入标签"},{default:s(()=>[(u(!0),f(I,null,P(n.tags,o=>(u(),K($,{key:o,label:o,value:o},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})],512),[[X,i.value===1]]),j(l("div",$e,[e[19]||(e[19]=l("div",{class:"section-title"},[l("span",{class:"title-icon"},"⚙️"),l("span",null,"初始化参数设置")],-1)),l("div",Be,[l("div",Ke,[e[13]||(e[13]=l("label",{class:"param-label"},"分块大小",-1)),t(q,{content:"文本分块的字符数，建议100-5000",placement:"top"},{default:s(()=>[t(D,{modelValue:n.chunk_size,"onUpdate:modelValue":e[4]||(e[4]=o=>n.chunk_size=o),min:100,max:5e3,step:100,size:"default","aria-label":"设置分块大小"},null,8,["modelValue"])]),_:1}),e[14]||(e[14]=l("span",{class:"param-desc"},"字符数",-1))]),l("div",Ue,[e[15]||(e[15]=l("label",{class:"param-label"},"重叠大小",-1)),t(q,{content:"分块间的重叠字符数，建议0-1000",placement:"top"},{default:s(()=>[t(D,{modelValue:n.chunk_overlap,"onUpdate:modelValue":e[5]||(e[5]=o=>n.chunk_overlap=o),min:0,max:1e3,step:50,size:"default","aria-label":"设置重叠大小"},null,8,["modelValue"])]),_:1}),e[16]||(e[16]=l("span",{class:"param-desc"},"字符数",-1))]),l("div",Se,[e[17]||(e[17]=l("label",{class:"param-label"},"分隔符",-1)),t(p,{modelValue:n.separator,"onUpdate:modelValue":e[6]||(e[6]=o=>n.separator=o),placeholder:"例如：\\n\\n",size:"default",clearable:"","aria-label":"输入分隔符"},null,8,["modelValue"])]),l("div",De,[e[18]||(e[18]=l("label",{class:"param-label"},"嵌入模型",-1)),t(E,{modelValue:n.embedding_model,"onUpdate:modelValue":e[7]||(e[7]=o=>n.embedding_model=o),placeholder:"选择模型",size:"default",class:"model-select",clearable:"","aria-label":"选择嵌入模型"},{default:s(()=>[t($,{label:"text2vec-base",value:"text2vec-base"}),t($,{label:"text2vec-large",value:"text2vec-large"})]),_:1},8,["modelValue"])])])],512),[[X,i.value===2]])]),_:1},8,["model","label-width"])])]),_:1},8,["modelValue","title","width"])}}},Re=ee(Le,[["__scopeId","data-v-f10a7333"]]),Te={class:"knowledge-base"},Ee={class:"header"},qe={class:"knowledge-list-container"},Fe={class:"knowledge-list"},Ne=["onClick"],je={class:"knowledge-header"},Pe={class:"knowledge-info"},We={class:"knowledge-title"},Ge={class:"knowledge-description"},He={class:"knowledge-tags"},Je={class:"knowledge-footer"},Oe={class:"update-time"},Qe={class:"el-dropdown-link"},Ae={class:"pagination"},Xe={key:1,class:"empty-state"},Ye={__name:"KnowledgeList",setup(le){const w=c(""),V=c([]),g=c(!1),k=c(0),_=c(1),y=c(6),i=c(),b=ne(),x=_e();let U=null;const n=a=>{if(!a)return"未知时间";try{const e=new Date(a),p=Math.floor((new Date-e)/(1e3*60*60*24));return p===0?"今天":p===1?"昨天":p<7?`${p}天前`:p<30?`${Math.floor(p/7)}周前`:e.toLocaleDateString()}catch{return a}},C=async()=>{g.value=!0;try{const a={page:_.value,page_size:y.value};w.value.trim()&&(a.search=w.value.trim());const e=await ve(a);V.value=e.items||[],k.value=e.total||0,x.setKBList(V.value)}catch{h.error("获取知识库列表失败"),V.value=[],k.value=0}finally{g.value=!1}};ie(w,a=>{U&&clearTimeout(U),U=setTimeout(()=>{_.value=1,C()},500)});const L=a=>{_.value=a,C()},R=a=>{y.value=a,_.value=1,C()},T=a=>{x.setCurrentKB(a),fe(a.id).then(e=>{x.setUserRole(e.role)}).catch(e=>{console.error("获取用户角色失败:",e),x.setUserRole(0)}),b.push(`/knowledgebase/${a.id}`)},W=async a=>{try{const e=await be({title:`${a.name} 的对话`,kb_id:a.id}),v=String(e.chat_id);b.push({path:"/service",query:{chatId:v}})}catch(e){console.error("创建对话失败:",e),h.error("创建对话失败，请稍后重试")}},G=()=>{i.value.open()},H=a=>{console.log("编辑知识库:",a.id)},Y=a=>{pe.confirm("确定要删除该知识库吗？此操作不可撤销！","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await ge(a.id),h.success("删除成功"),C()}catch(e){h.error("删除失败"),console.error("删除异常:",e)}}).catch(()=>{h.info("已取消删除")})},J=(a,e)=>{a==="edit"?H(e):a==="delete"&&Y(e)};return re(()=>{C()}),(a,e)=>{const v=r("el-icon"),p=r("el-input"),S=r("el-button"),O=r("el-avatar"),$=r("el-tag"),E=r("More"),D=r("el-dropdown-item"),q=r("el-dropdown-menu"),Q=r("el-dropdown"),B=r("el-pagination"),A=r("el-empty"),o=de("loading");return u(),f("div",Te,[l("div",Ee,[t(p,{modelValue:w.value,"onUpdate:modelValue":e[0]||(e[0]=d=>w.value=d),placeholder:"搜索知识库名称、描述或标签",class:"pill-input search-input",clearable:""},{prefix:s(()=>[t(v,null,{default:s(()=>[t(ue(ce))]),_:1})]),_:1},8,["modelValue"]),t(S,{type:"primary",onClick:G,round:"",class:"create-btn"},{default:s(()=>e[4]||(e[4]=[m(" 创建知识库 ")])),_:1,__:[4]})]),t(Re,{ref_key:"createDialog",ref:i},null,512),j((u(),f("div",qe,[V.value.length>0?(u(),f(I,{key:0},[l("div",Fe,[(u(!0),f(I,null,P(V.value,d=>(u(),f("div",{key:d.id,class:"knowledge-card",onClick:M=>T(d)},[l("div",je,[t(O,{src:d.icon,size:60,class:"item-icon"},null,8,["src"]),l("div",Pe,[l("h3",We,z(d.name),1),l("p",Ge,z(d.description),1)])]),l("div",He,[(u(!0),f(I,null,P(d.tags,(M,te)=>(u(),K($,{key:te,size:"small"},{default:s(()=>[m(z(M),1)]),_:2},1024))),128)),t($,{size:"small",effect:"plain"},{default:s(()=>[m(z(d.status),1)]),_:2},1024)]),l("div",Je,[l("span",Oe,"最后更新: "+z(n(d.updated_at)),1),t(S,{type:"primary",size:"small",onClick:Z(M=>W(d),["stop"])},{default:s(()=>e[5]||(e[5]=[m(" 开始对话 ")])),_:2,__:[5]},1032,["onClick"])]),l("div",{class:"more-options",onClick:e[1]||(e[1]=Z(()=>{},["stop"]))},[t(Q,{trigger:"click",onCommand:M=>J(M,d)},{dropdown:s(()=>[t(q,null,{default:s(()=>[t(D,{command:"edit"},{default:s(()=>e[6]||(e[6]=[m("编辑")])),_:1,__:[6]}),t(D,{command:"delete"},{default:s(()=>e[7]||(e[7]=[m("删除")])),_:1,__:[7]})]),_:1})]),default:s(()=>[l("span",Qe,[t(v,{class:"more-icon"},{default:s(()=>[t(E)]),_:1})])]),_:2},1032,["onCommand"])])],8,Ne))),128))]),l("div",Ae,[t(B,{"current-page":_.value,"onUpdate:currentPage":e[2]||(e[2]=d=>_.value=d),"page-size":y.value,"onUpdate:pageSize":e[3]||(e[3]=d=>y.value=d),total:k.value,"page-sizes":[6,12,18,24],layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:L,onSizeChange:R},null,8,["current-page","page-size","total"])])],64)):(u(),f("div",Xe,[t(A,{description:w.value?"未找到匹配的知识库":"暂无知识库"},null,8,["description"])]))])),[[o,g.value]])])}}},al=ee(Ye,[["__scopeId","data-v-ec8f81a9"]]);export{al as default};
