import{W as we,e as m,d as Z,r as y,p as M,o as I,w as l,a as e,f as D,i as v,a2 as Ve,E as h,c as H,F as de,C as ie,m as pe,q as me,K as Y,g as s,a3 as Ce,B as W,a4 as ke,n as he,z as Se,b as ae,P as Ue,H as xe,a5 as q,a6 as te,a7 as Ie,a8 as De,a9 as Ee,aa as Ne,I as Re,ab as X,ac as se,ad as oe,ae as O,af as A,ag as $e,ah as z,ai as ne,aj as Be,ak as Ae,L as re,al as ue}from"./index-D3azu4XD.js";import{_ as K}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ze=T=>{const E={};return T&&(E.tenantId=T),we("/departments",E)},Le={class:"dialog-footer"},Me={__name:"EditUser",emits:["success"],setup(T,{expose:E,emit:V}){const o=m(!1),g=m(!1),w=m(null),n=Z({userId:"",userName:"",role:"",phone:"",status:""}),x={userName:[{required:!0,message:"请输入用户名",trigger:"blur"}],role:[{required:!0,message:"请选择角色",trigger:"change"}],status:[{required:!0,message:"请选择状态",trigger:"change"}]},c=p=>{o.value=!0,n.userId=p.userId,n.userName=p.userName,n.role=p.role,n.phone=p.phone,n.status=p.status},C=()=>{o.value=!1},N=V,f=async()=>{try{g.value=!0,await w.value.validate(),await Ve(n.userId,{userName:n.userName,role:n.role,phone:n.phone,status:n.status}),h.success("用户更新成功"),o.value=!1,N("success",{...n})}catch{}finally{g.value=!1}};return E({open:c}),(p,u)=>{const R=y("el-input"),U=y("el-form-item"),b=y("el-option"),B=y("el-select"),i=y("el-form"),a=y("el-button"),P=y("el-dialog");return I(),M(P,{modelValue:o.value,"onUpdate:modelValue":u[5]||(u[5]=k=>o.value=k),title:"编辑用户",width:"520px","before-close":C},{footer:l(()=>[D("span",Le,[e(a,{onClick:C},{default:l(()=>u[6]||(u[6]=[v("取消")])),_:1,__:[6]}),e(a,{type:"primary",loading:g.value,onClick:f},{default:l(()=>u[7]||(u[7]=[v("保存")])),_:1,__:[7]},8,["loading"])])]),default:l(()=>[e(i,{ref_key:"formRef",ref:w,model:n,rules:x,"label-width":"100px","label-position":"right"},{default:l(()=>[e(U,{label:"用户ID"},{default:l(()=>[e(R,{modelValue:n.userId,"onUpdate:modelValue":u[0]||(u[0]=k=>n.userId=k),disabled:""},null,8,["modelValue"])]),_:1}),e(U,{label:"用户名",prop:"userName"},{default:l(()=>[e(R,{modelValue:n.userName,"onUpdate:modelValue":u[1]||(u[1]=k=>n.userName=k),placeholder:"请输入用户名",clearable:""},null,8,["modelValue"])]),_:1}),e(U,{label:"角色",prop:"role"},{default:l(()=>[e(B,{modelValue:n.role,"onUpdate:modelValue":u[2]||(u[2]=k=>n.role=k),placeholder:"请选择角色",style:{width:"100%"}},{default:l(()=>[e(b,{label:"平台管理员",value:"platform_admin"}),e(b,{label:"超级管理员",value:"super_admin"}),e(b,{label:"知识库所有人",value:"kb_owner"}),e(b,{label:"知识库管理员",value:"kb_admin"}),e(b,{label:"普通用户",value:"user"})]),_:1},8,["modelValue"])]),_:1}),e(U,{label:"手机号",prop:"phone"},{default:l(()=>[e(R,{modelValue:n.phone,"onUpdate:modelValue":u[3]||(u[3]=k=>n.phone=k),placeholder:"请输入手机号",clearable:""},null,8,["modelValue"])]),_:1}),e(U,{label:"状态",prop:"status"},{default:l(()=>[e(B,{modelValue:n.status,"onUpdate:modelValue":u[4]||(u[4]=k=>n.status=k),placeholder:"请选择状态",style:{width:"100%"}},{default:l(()=>[e(b,{label:"开启",value:"开启"}),e(b,{label:"关闭",value:"关闭"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])}}},Fe=K(Me,[["__scopeId","data-v-4226ad1f"]]),qe={class:"dialog-footer"},Te={__name:"CreateUser",setup(T,{expose:E}){const V=m(!1),o=Z({username:"",email:"",role:"user",password:""}),g=[{label:"普通用户",value:"user"},{label:"知识库管理员",value:"admin"},{label:"知识库所有人",value:"superadmin"},{label:"超级管理员",value:"superadmin"}],w={username:[{required:!0,message:"请输入用户名称",trigger:"blur"},{min:2,max:20,message:"长度在 2 到 20 个字符",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],role:[{required:!0,message:"请选择角色",trigger:"change"}],password:[{required:!0,message:"请输入默认密码",trigger:"blur"},{min:6,max:20,message:"长度在 6 到 20 个字符",trigger:"blur"}]},n=m(null),x=()=>{V.value=!0},c=()=>{n.value?.resetFields(),V.value=!1},C=async()=>{try{await n.value.validate(),h.success("用户创建成功"),c()}catch(N){console.error("表单验证失败:",N)}};return E({open:x}),(N,f)=>{const p=y("el-input"),u=y("el-form-item"),R=y("el-option"),U=y("el-select"),b=y("el-form"),B=y("el-button"),i=y("el-dialog");return I(),M(i,{modelValue:V.value,"onUpdate:modelValue":f[4]||(f[4]=a=>V.value=a),title:"新增用户",width:"500px","before-close":c},{footer:l(()=>[D("span",qe,[e(B,{onClick:c},{default:l(()=>f[5]||(f[5]=[v("取消")])),_:1,__:[5]}),e(B,{type:"primary",onClick:C},{default:l(()=>f[6]||(f[6]=[v("确定")])),_:1,__:[6]})])]),default:l(()=>[e(b,{ref_key:"formRef",ref:n,model:o,rules:w,"label-width":"100px","label-position":"right"},{default:l(()=>[e(u,{label:"用户名称",prop:"username"},{default:l(()=>[e(p,{modelValue:o.username,"onUpdate:modelValue":f[0]||(f[0]=a=>o.username=a),placeholder:"请输入用户名称",clearable:""},null,8,["modelValue"])]),_:1}),e(u,{label:"邮箱",prop:"email"},{default:l(()=>[e(p,{modelValue:o.email,"onUpdate:modelValue":f[1]||(f[1]=a=>o.email=a),placeholder:"请输入邮箱",clearable:""},null,8,["modelValue"])]),_:1}),e(u,{label:"角色",prop:"role"},{default:l(()=>[e(U,{modelValue:o.role,"onUpdate:modelValue":f[2]||(f[2]=a=>o.role=a),placeholder:"请选择角色",style:{width:"100%"}},{default:l(()=>[(I(),H(de,null,ie(g,a=>e(R,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),e(u,{label:"默认密码",prop:"password"},{default:l(()=>[e(p,{modelValue:o.password,"onUpdate:modelValue":f[3]||(f[3]=a=>o.password=a),placeholder:"请输入默认密码","show-password":"",clearable:""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])}}},je=K(Te,[["__scopeId","data-v-4cdf8f57"]]),Oe={key:0,class:"result-area"},Pe={class:"button-row"},We={__name:"BatchImport",emits:["import-success"],setup(T,{expose:E}){const V=m(!1),o=m(null),g=m([]),w=m(""),n=Z({file:null}),x=pe(()=>{if(g.value.length===0)return!1;const i=g.value[0].raw;return i&&i.size<=10*1024*1024&&c(i.name)}),c=i=>i.toLowerCase().endsWith(".csv"),C=()=>{V.value=!0,g.value=[],w.value=""},N=()=>{g.value=[],w.value="",V.value=!1},f=(i,a)=>{g.value=a,n.file=i.raw},p=()=>{n.file=null,g.value=[]},u=i=>{const a=i.dataTransfer.files[0];a&&c(a.name)&&a.size<=10*1024*1024?(g.value=[{raw:a,name:a.name,status:"ready"}],f({raw:a},g.value)):h.error("请上传有效的 CSV 文件（最大 10MB）")},R=i=>{i.preventDefault()},U=()=>{o.value.$refs.input.click()},b=()=>{const i=document.createElement("a");i.href="/template.csv",i.download="user_template.csv",i.click(),h.success("模板下载成功")},B=async()=>{if(!n.file||!x.value){h.warning("请选择一个有效的 CSV 文件（最大 10MB）");return}const i=new FormData;i.append("file",n.file);try{const a=await ke(i);a.success?(w.value=`批量导入成功，新增 ${a.successCount} 条记录，失败 ${a.failCount} 条`,h.success(w.value),N(),emit("import-success")):(w.value=`批量导入失败: ${a.message||"未知错误"}`,h.error(w.value))}catch(a){console.error("上传失败:",a),w.value="上传过程中发生错误，请稍后重试",h.error(w.value)}};return E({open:C}),(i,a)=>{const P=y("el-icon"),k=y("el-upload"),j=y("el-button"),G=y("el-dialog");return I(),M(G,{modelValue:V.value,"onUpdate:modelValue":a[0]||(a[0]=J=>V.value=J),title:"批量导入用户",width:"500px","before-close":N},{default:l(()=>[e(k,{ref_key:"uploadRef",ref:o,"auto-upload":!1,"file-list":g.value,limit:1,accept:".csv","on-change":f,"on-remove":p,class:"upload-demo",action:"","on-drop":u,"on-dragover":R},{tip:l(()=>a[4]||(a[4]=[D("div",{class:"el-upload__tip"}," 文件应包含字段：username, email, role, password ",-1)])),default:l(()=>[D("div",{class:"drag-area",onDrop:Y(u,["prevent"]),onDragover:Y(R,["prevent"]),onClick:U},[D("div",null,[a[1]||(a[1]=v(" 点击上传 CSV 文件")),e(P,null,{default:l(()=>[e(s(Ce))]),_:1}),a[2]||(a[2]=D("br",null,null,-1)),a[3]||(a[3]=v("仅支持 .csv 格式文件，最大 10MB "))])],32)]),_:1},8,["file-list"]),w.value?(I(),H("div",Oe,W(w.value),1)):me("",!0),D("div",Pe,[e(j,{onClick:b,class:"upload-template"},{default:l(()=>a[5]||(a[5]=[v("下载模板")])),_:1,__:[5]}),e(j,{onClick:N},{default:l(()=>a[6]||(a[6]=[v("取消")])),_:1,__:[6]}),e(j,{type:"primary",disabled:g.value.length===0||!x.value,onClick:B},{default:l(()=>a[7]||(a[7]=[v("上传")])),_:1,__:[7]},8,["disabled"])])]),_:1},8,["modelValue"])}}},He=K(We,[["__scopeId","data-v-579a2c99"]]),Ke={class:"user-management"},Ge={style:{padding:"40px 0","text-align":"center",color:"#999"}},Je={style:{"font-size":"12px","margin-top":"8px"}},Qe={__name:"UserList",setup(T){const E=m(),V=m(),o=m({id:"",userName:"",tenantSuperAdmin:null,status:null}),g=()=>{console.log("创建用户"),E.value.open()},w=()=>{V.value?(console.log("Opening BatchImport:",V.value),V.value.open()):console.error("batchImport ref is not available")},n=m([]),x=m(null),c=m([]),C=m([]),N=m(null),f=m(null),p=m(0),u=m(1),R=m(10),U=m(!1),b=m(!1),B=pe(()=>c.value||[]);he(u,()=>{a()},{immediate:!1}),Se(async()=>{await i(),await a()});const i=async()=>{try{const t=ae().tenant?.id,_=await ze(t);_&&_.items?n.value=_.items.map(r=>({id:r.id,name:r.name})):Array.isArray(_)?n.value=_.map(r=>({id:r.id,name:r.name})):n.value=[]}catch(d){console.error("获取部门数据失败",d),h.error("获取部门数据失败: "+(d.message||"未知错误")),n.value=[]}},a=async()=>{U.value=!0;try{const _={tenantId:ae().tenant?.id,page:u.value,size:R.value};if(o.value.id&&(_.id=o.value.id),o.value.userName&&(_.userName=o.value.userName),o.value.tenantSuperAdmin!==null&&o.value.tenantSuperAdmin!==""&&(_.tenantSuperAdmin=o.value.tenantSuperAdmin),o.value.status!==null&&o.value.status!==""&&(_.status=o.value.status),x.value){const $=n.value.find(L=>L.id.toString()===x.value);$&&(_.department=$.name)}const r=await Ue(_);if(r&&r.items){const $=r.items.map(L=>{const{page:F,size:Q,...S}=L;return S});c.value=$,p.value=r.total||0}else if(Array.isArray(r)){const $=r.map(L=>{const{page:F,size:Q,...S}=L;return S});c.value=$,p.value=$.length}else c.value=[],p.value=0}catch(d){console.error("获取用户数据失败",d),h.error("获取用户数据失败: "+(d.message||"未知错误")),c.value=[],p.value=0}finally{U.value=!1}},P=d=>{x.value=d,u.value=1,a()},k=()=>{u.value=1,a(),h.success("筛选完成")},j=()=>{o.value={id:"",userName:"",tenantSuperAdmin:null,status:null},x.value=null,u.value=1,a()},G=d=>{f.value?.open(d)},J=d=>{re.confirm(`确认删除用户「${d.userName}」吗？`,"提示",{type:"warning"}).then(async()=>{try{await ue(d.id),h.success("已删除");const t=c.value.findIndex(_=>String(_.id)===String(d.id));t!==-1&&(c.value.splice(t,1),p.value=Math.max(0,p.value-1),c.value.length===0&&u.value>1&&(u.value=u.value-1,a()))}catch(t){console.error("删除失败:",t),h.error("删除失败: "+(t.message||"未知错误"))}}).catch(()=>{})},ce=d=>{u.value=d,a()},fe=d=>{C.value=d||[]},ve=async()=>{if(C.value.length===0)return;const d=C.value.map(t=>t.id);try{await re.confirm(`确认批量删除选中的 ${d.length} 位用户吗？`,"提示",{type:"warning"}),await Promise.all(d.map(t=>ue(t))),c.value=c.value.filter(t=>!d.includes(t.id)),p.value=Math.max(0,p.value-d.length),N.value?.clearSelection(),C.value=[],h.success("批量删除成功")}catch{}},_e=()=>{if(C.value.length===0){h.warning("请先勾选需要导出的用户");return}const d=["用户ID","用户名","角色","部门","邮箱","状态","加入时间"],t=S=>{const ee=S==null?"":String(S),ye=/[",\n]/.test(ee),le=ee.replace(/"/g,'""');return ye?`"${le}"`:le},_=C.value.map(S=>[S.id,S.userName,S.tenantSuperAdmin?"超级管理员":"普通用户",S.departmentName,S.email,S.status===1?"开通":"关闭",S.create_time].map(t).join(",")),r="\uFEFF"+[d.join(","),..._].join(`
`),$=new Blob([r],{type:"text/csv;charset=utf-8;"}),L=URL.createObjectURL($),F=document.createElement("a"),Q=new Date().toISOString().replace(/[-:T]/g,"").slice(0,14);F.href=L,F.download=`users_export_${Q}.csv`,document.body.appendChild(F),F.click(),document.body.removeChild(F),URL.revokeObjectURL(L)},ge=d=>{const t=c.value.findIndex(_=>String(_.id)===String(d.id));t>=0?c.value[t]={...c.value[t],...d}:a()},be=()=>{b.value=!b.value};return(d,t)=>{const _=xe("loading");return I(),H("div",Ke,[e(s(X),{gutter:16},{default:l(()=>[e(s(q),{span:b.value?1:4,class:"department-col"},{default:l(()=>[D("div",{class:"collapse-toggle",onClick:Y(be,["stop"])},[e(s(te),null,{default:l(()=>[b.value?(I(),M(s(Ie),{key:0})):(I(),M(s(De),{key:1}))]),_:1})]),b.value?me("",!0):(I(),M(s(Ee),{key:0,"default-active":x.value,class:"el-menu-vertical-demo",onSelect:P},{default:l(()=>[(I(!0),H(de,null,ie(n.value,r=>(I(),M(s(Ne),{key:r.id,index:r.id.toString()},{default:l(()=>[D("span",null,W(r.name),1)]),_:2},1032,["index"]))),128))]),_:1},8,["default-active"]))]),_:1},8,["span"]),e(s(q),{span:b.value?23:20},{default:l(()=>[e(s(X),{gutter:16,class:"filter-row"},{default:l(()=>[e(s(q),{span:4},{default:l(()=>[e(s(se),{placeholder:"请输入用户ID",modelValue:o.value.id,"onUpdate:modelValue":t[0]||(t[0]=r=>o.value.id=r),clearable:""},null,8,["modelValue"])]),_:1}),e(s(q),{span:4},{default:l(()=>[e(s(se),{placeholder:"请输入用户名",modelValue:o.value.userName,"onUpdate:modelValue":t[1]||(t[1]=r=>o.value.userName=r),clearable:""},null,8,["modelValue"])]),_:1}),e(s(q),{span:4},{default:l(()=>[e(s(oe),{modelValue:o.value.tenantSuperAdmin,"onUpdate:modelValue":t[2]||(t[2]=r=>o.value.tenantSuperAdmin=r),placeholder:"选择角色",style:{width:"100%"}},{default:l(()=>[e(s(O),{label:"全部",value:null}),e(s(O),{label:"超级管理员",value:!0}),e(s(O),{label:"普通用户",value:!1})]),_:1},8,["modelValue"])]),_:1}),e(s(q),{span:4},{default:l(()=>[e(s(oe),{modelValue:o.value.status,"onUpdate:modelValue":t[3]||(t[3]=r=>o.value.status=r),placeholder:"选择状态",style:{width:"100%"}},{default:l(()=>[e(s(O),{label:"全部",value:null}),e(s(O),{label:"开通",value:1}),e(s(O),{label:"关闭",value:0})]),_:1},8,["modelValue"])]),_:1}),e(s(q),{span:4,class:"button-group"},{default:l(()=>[e(s(A),{type:"primary",onClick:k},{default:l(()=>t[5]||(t[5]=[v("查询")])),_:1,__:[5]}),e(s(A),{onClick:j},{default:l(()=>t[6]||(t[6]=[v("重置")])),_:1,__:[6]})]),_:1})]),_:1}),e(s(X),{class:"batch-actions",style:{"margin-top":"20px"}},{default:l(()=>[e(s(A),{type:"danger",onClick:g},{default:l(()=>t[7]||(t[7]=[v("新增")])),_:1,__:[7]}),e(je,{ref_key:"createDialog",ref:E},null,512),e(s(A),{type:"primary",onClick:w},{default:l(()=>t[8]||(t[8]=[v("批量导入")])),_:1,__:[8]}),e(He,{ref_key:"batchImport",ref:V,onImportSuccess:a},null,512),e(s(A),{type:"primary",disabled:C.value.length===0,onClick:ve},{default:l(()=>t[9]||(t[9]=[v("批量删除")])),_:1,__:[9]},8,["disabled"]),e(s(A),{type:"primary",disabled:C.value.length===0,onClick:_e},{default:l(()=>t[10]||(t[10]=[v("用户导出")])),_:1,__:[10]},8,["disabled"])]),_:1}),Re((I(),M(s($e),{ref_key:"tableRef",ref:N,data:B.value,style:{width:"100%"},stripe:"",onSelectionChange:fe,"row-style":{height:"50px"}},{empty:l(()=>[D("div",Ge,[e(s(te),{style:{"font-size":"48px","margin-bottom":"16px"}},{default:l(()=>[e(s(Be))]),_:1}),t[15]||(t[15]=D("p",null,"暂无数据",-1)),D("p",Je,[t[14]||(t[14]=v(" 请尝试调整筛选条件或 ")),e(s(A),{link:"",onClick:j},{default:l(()=>t[13]||(t[13]=[v("清除所有筛选")])),_:1,__:[13]})])])]),default:l(()=>[e(s(z),{type:"selection",width:"55"}),e(s(z),{prop:"id",label:"用户ID",width:"80"}),e(s(z),{prop:"userName",label:"用户名"}),e(s(z),{prop:"role",label:"角色",width:"120"},{default:l(({row:r})=>[e(s(ne),{type:r.tenantSuperAdmin?"warning":"info"},{default:l(()=>[v(W(r.tenantSuperAdmin?"超级管理员":"普通用户"),1)]),_:2},1032,["type"])]),_:1}),e(s(z),{prop:"departmentName",label:"所属部门"}),e(s(z),{prop:"email",label:"邮箱"}),e(s(z),{prop:"status",label:"状态",width:"100"},{default:l(({row:r})=>[e(s(ne),{type:r.status===1?"success":"danger"},{default:l(()=>[v(W(r.status===1?"开通":"关闭"),1)]),_:2},1032,["type"])]),_:1}),e(s(z),{prop:"create_time",label:"加入时间",width:"160"}),e(s(z),{label:"操作",width:"200"},{default:l(({row:r})=>[e(s(A),{size:"small",type:"success",onClick:$=>G(r)},{default:l(()=>t[11]||(t[11]=[v("编辑")])),_:2,__:[11]},1032,["onClick"]),e(s(A),{size:"small",type:"danger",onClick:$=>J(r)},{default:l(()=>t[12]||(t[12]=[v("删除")])),_:2,__:[12]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[_,U.value]]),e(s(Ae),{"current-page":u.value,"onUpdate:currentPage":t[4]||(t[4]=r=>u.value=r),total:p.value,"page-size":R.value,layout:"total, prev, pager, next, jumper",onCurrentChange:ce},null,8,["current-page","total","page-size"]),e(Fe,{ref_key:"editUserRef",ref:f,onSuccess:ge},null,512)]),_:1},8,["span"])]),_:1})])}}},Ze=K(Qe,[["__scopeId","data-v-4f9a9c45"]]);export{Ze as default};
