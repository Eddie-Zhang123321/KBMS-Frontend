import{r as e,d as a,a as l,b1 as t,U as u,J as s,V as n,a1 as r,I as d,a0 as i,av as o,K as m,Z as c,X as p,ae as v,u as f,cb as g,$ as _,w as y,F as b,bh as h,aX as w,aW as k,W as C,c2 as V}from"./vue-vendor-BUDnSszI.js";import{a as x,c as S,e as U,g as A,f as $,h as j,i as N}from"./index-8D9d6p3q.js";import{_ as I}from"./_plugin-vue_export-helper-BCo6x5W8.js";import{aL as z,aX as L,aY as R,aZ as D,a_ as B,a$ as O,b0 as T,b1 as q,b2 as E,b3 as M,b4 as W,b5 as F,b6 as X,b7 as K,aK as Z}from"./vendor-zcc-V1Og.js";import"./network-vendor-ztdpVPaQ.js";const J=()=>x("/departments"),P={class:"dialog-footer"},Y=I({__name:"CreateUser",emits:["user-created"],setup(p,{expose:v,emit:f}){const g=f,_=e(!1),y=a(()=>window.innerWidth<=768),b=a(()=>y.value?"95%":"500px"),h=l({userName:"",email:"",tenantSuperAdmin:!1,password:"",department:""}),w=[{label:"普通用户",value:!1},{label:"超级管理员",value:!0}],k=e([]),C={userName:[{required:!0,message:"请输入用户名称",trigger:"blur"},{min:2,max:20,message:"长度在 2 到 20 个字符",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],tenantSuperAdmin:[{required:!0,message:"请选择角色",trigger:"change"}],password:[{required:!0,message:"请输入默认密码",trigger:"blur"},{min:6,max:20,message:"长度在 6 到 20 个字符",trigger:"blur"}],department:[{required:!0,message:"请选择部门",trigger:"change"},{validator:(e,a,l)=>{a?k.value.some(e=>e.name===a)?l():l(new Error("请选择有效的部门")):l(new Error("请选择部门"))},trigger:"change"}]},V=e(null),x=()=>{V.value?.resetFields(),_.value=!1},U=async()=>{try{await V.value.validate();const e=await S(h);z.success("用户创建成功"),g("user-created",e?.data||e),x()}catch(e){z.error("创建用户失败: "+(e.message||"未知错误"))}};return v({open:()=>{_.value=!0,(async()=>{try{const e=await J();e&&e.data&&e.data.items?k.value=e.data.items.map(e=>({id:e.id,name:e.name})):e&&e.items?k.value=e.items.map(e=>({id:e.id,name:e.name})):Array.isArray(e)?k.value=e.map(e=>({id:e.id,name:e.name})):k.value=[]}catch(e){z.error("获取部门数据失败: "+(e.message||"未知错误")),k.value=[]}})()}}),(e,a)=>{const l=t("el-input"),p=t("el-form-item"),v=t("el-option"),f=t("el-select"),g=t("el-form"),S=t("el-button"),A=t("el-dialog");return s(),u(A,{modelValue:_.value,"onUpdate:modelValue":a[5]||(a[5]=e=>_.value=e),title:"新增用户",width:b.value,"before-close":x,fullscreen:y.value},{footer:n(()=>[m("span",P,[r(S,{onClick:x},{default:n(()=>a[6]||(a[6]=[c("取消")])),_:1,__:[6]}),r(S,{type:"primary",onClick:U},{default:n(()=>a[7]||(a[7]=[c("确定")])),_:1,__:[7]})])]),default:n(()=>[r(g,{ref_key:"formRef",ref:V,model:h,rules:C,"label-width":"100px","label-position":"right"},{default:n(()=>[r(p,{label:"用户名称",prop:"userName"},{default:n(()=>[r(l,{modelValue:h.userName,"onUpdate:modelValue":a[0]||(a[0]=e=>h.userName=e),placeholder:"请输入用户名称",clearable:""},null,8,["modelValue"])]),_:1}),r(p,{label:"邮箱",prop:"email"},{default:n(()=>[r(l,{modelValue:h.email,"onUpdate:modelValue":a[1]||(a[1]=e=>h.email=e),placeholder:"请输入邮箱",clearable:""},null,8,["modelValue"])]),_:1}),r(p,{label:"部门",prop:"department"},{default:n(()=>[r(f,{modelValue:h.department,"onUpdate:modelValue":a[2]||(a[2]=e=>h.department=e),placeholder:"请选择部门",style:{width:"100%"},clearable:""},{default:n(()=>[(s(!0),d(i,null,o(k.value,e=>(s(),u(v,{key:e.id,label:e.name,value:e.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),r(p,{label:"角色",prop:"tenantSuperAdmin"},{default:n(()=>[r(f,{modelValue:h.tenantSuperAdmin,"onUpdate:modelValue":a[3]||(a[3]=e=>h.tenantSuperAdmin=e),placeholder:"请选择角色",style:{width:"100%"}},{default:n(()=>[(s(),d(i,null,o(w,e=>r(v,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),r(p,{label:"默认密码",prop:"password"},{default:n(()=>[r(l,{modelValue:h.password,"onUpdate:modelValue":a[4]||(a[4]=e=>h.password=e),placeholder:"请输入默认密码","show-password":"",clearable:""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width","fullscreen"])}}},[["__scopeId","data-v-062b927f"]]),G={key:0,class:"result-area"},H={class:"button-row"},Q=I({__name:"BatchImport",emits:["import-success"],setup(i,{expose:o,emit:y}){const b=e(!1),h=e(null),w=e([]),k=e(""),C=l({file:null}),V=a(()=>{if(0===w.value.length)return!1;const e=w.value[0].raw;return e&&e.size<=5242880&&x(e.name)}),x=e=>e.toLowerCase().endsWith(".csv"),S=()=>{w.value=[],k.value="",b.value=!1},A=(e,a)=>{w.value=a,C.file=e.raw},$=()=>{C.file=null,w.value=[]},j=e=>{const a=e.dataTransfer.files[0];a&&x(a.name)&&a.size<=5242880?(w.value=[{raw:a,name:a.name,status:"ready"}],A({raw:a},w.value)):z.error("请上传有效的 CSV 文件（最大 5MB）")},N=e=>{e.preventDefault()},I=()=>{h.value.$refs.input.click()},L=()=>{const e="\ufeff"+[["userName","email","department","tenantSuperAdmin","createTime"].join(","),...[["zhangsan","zhangsan@example.com","技术部","false","2024-01-15 14:30:00"],["lisi","lisi@example.com","销售部","true","2024-01-15 15:30:00"],["wangwu","wangwu@example.com","人事部","false","2024-01-15 16:30:00"]].map(e=>e.join(","))].join("\n"),a=new Blob([e],{type:"text/csv;charset=utf-8;"}),l=URL.createObjectURL(a),t=document.createElement("a");t.href=l,t.download="user_import_template.csv",document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(l),z.success("模板下载成功")},R=async()=>{if(!C.file||!V.value)return void z.warning("请选择一个有效的 CSV 文件（最大 5MB）");const e=new FormData;e.append("file",C.file);try{const a=await U(e);let l=a;if(a&&"object"==typeof a&&void 0!==a.data&&(l=a.data),l&&void 0!==l.importedCount){const e=l.importedCount||0;e>0?(k.value=`批量导入成功，新增 ${e} 个用户`,z.success(k.value),D("import-success"),S()):(k.value="没有成功导入任何用户",z.warning(k.value))}else if(l&&void 0!==l.success)if(l.success){const e=l.importedCount||l.count||0;k.value=`批量导入成功，新增 ${e} 个用户`,z.success(k.value),D("import-success"),S()}else k.value=`批量导入失败: ${l.message||"未知错误"}`,z.error(k.value);else l&&l.message?(k.value=`批量导入失败: ${l.message}`,z.error(k.value)):(k.value="批量导入成功",z.success(k.value),D("import-success"),S())}catch(a){a.response&&a.response.data&&a.response.data.message?k.value=`批量导入失败: ${a.response.data.message}`:a.message&&(a.message.includes("批量导入")||a.message.includes("导入"))?k.value=a.message:(k.value="上传过程中发生错误，请稍后重试",z.error(k.value))}},D=y;return o({open:()=>{b.value=!0,w.value=[],k.value=""}}),(e,a)=>{const l=t("el-icon"),i=t("el-upload"),o=t("el-button"),y=t("el-dialog");return s(),u(y,{modelValue:b.value,"onUpdate:modelValue":a[0]||(a[0]=e=>b.value=e),title:"批量导入用户",width:"500px","before-close":S},{default:n(()=>[r(i,{ref_key:"uploadRef",ref:h,"auto-upload":!1,"file-list":w.value,limit:1,accept:".csv","on-change":A,"on-remove":$,class:"upload-demo",action:"","on-drop":j,"on-dragover":N},{tip:n(()=>a[4]||(a[4]=[m("div",{class:"el-upload__tip"},[c(" 文件应包含字段：userName, email, department, tenantSuperAdmin, createTime"),m("br"),c(' 注意：id和status字段由系统自动生成，导入的用户默认状态为"开通" ')],-1)])),default:n(()=>[m("div",{class:"drag-area",onDrop:v(j,["prevent"]),onDragover:v(N,["prevent"]),onClick:I},[m("div",null,[a[1]||(a[1]=c(" 点击上传 CSV 文件")),r(l,null,{default:n(()=>[r(f(g))]),_:1}),a[2]||(a[2]=m("br",null,null,-1)),a[3]||(a[3]=c("仅支持 .csv 格式文件，最大 5MB "))])],32)]),_:1},8,["file-list"]),k.value?(s(),d("div",G,_(k.value),1)):p("",!0),m("div",H,[r(o,{onClick:L,class:"upload-template"},{default:n(()=>a[5]||(a[5]=[c("下载模板")])),_:1,__:[5]}),r(o,{onClick:S},{default:n(()=>a[6]||(a[6]=[c("取消")])),_:1,__:[6]}),r(o,{type:"primary",disabled:0===w.value.length||!V.value,onClick:R},{default:n(()=>a[7]||(a[7]=[c("上传")])),_:1,__:[7]},8,["disabled"])])]),_:1},8,["modelValue"])}}},[["__scopeId","data-v-1f95a368"]]),ee={class:"user-management"},ae={style:{padding:"40px 0","text-align":"center",color:"#999"}},le={style:{"font-size":"12px","margin-top":"8px"}},te=I({__name:"UserList",setup(l){const t=e(),g=e(),x=e({id:"",userName:"",tenantSuperAdmin:null,status:null}),S=()=>{t.value.open()},U=e=>{e&&"object"==typeof e?(H.value.unshift(e),se.value=se.value+1,ne.value=1,z.success("新用户已添加到列表中")):ce()},I=()=>{g.value&&g.value.open()},P=e([]),G=e(null),H=e([]),te=e([]),ue=e(null),se=e(0),ne=e(1),re=e(10),de=e(!1),ie=e(!1),oe=a(()=>H.value||[]);y(ne,()=>{ce()},{immediate:!1}),b(async()=>{await me(),await ce()});const me=async()=>{try{const e=await J();e&&e.data&&e.data.items?P.value=e.data.items.map(e=>({id:e.id,name:e.name})):e&&e.items?P.value=e.items.map(e=>({id:e.id,name:e.name})):Array.isArray(e)?P.value=e.map(e=>({id:e.id,name:e.name})):P.value=[]}catch(e){z.error("获取部门数据失败: "+(e.message||"未知错误")),P.value=[]}},ce=async()=>{de.value=!0;try{const e={page:ne.value,pageSize:re.value,...x.value};if(G.value){const a=P.value.find(e=>e.id.toString()===G.value);a&&(e.department=a.name)}Object.keys(e).forEach(a=>{""!==e[a]&&null!==e[a]&&void 0!==e[a]||delete e[a]});const a=await A(e);a&&a.data&&a.data.items?(H.value=a.data.items,se.value=a.data.total||0):a&&a.items?(H.value=a.items,se.value=a.total||0):Array.isArray(a)?(H.value=a,se.value=a.length):(H.value=[],se.value=0)}catch(e){z.error("获取用户数据失败: "+(e.message||"未知错误")),H.value=[],se.value=0}finally{de.value=!1}},pe=e=>{G.value===e?G.value=null:G.value=e,ne.value=1,ce()},ve=()=>{ne.value=1,ce();x.value.id&&x.value.id.trim()||x.value.userName&&x.value.userName.trim()||null!==x.value.tenantSuperAdmin&&void 0!==x.value.tenantSuperAdmin||null!==x.value.status&&void 0!==x.value.status||G.value?z.success("筛选完成"):z.info("显示所有用户")},fe=()=>{x.value={id:"",userName:"",tenantSuperAdmin:null,status:null},G.value=null,ne.value=1,ce()},ge=e=>{ne.value=e,ce()},_e=e=>{te.value=e||[]},ye=async()=>{if(0===te.value.length)return;const e=te.value.map(e=>e.id);try{await Z.confirm(`确认批量删除选中的 ${e.length} 位用户吗？`,"提示",{type:"warning"});const a=await $(e),l=a?.data||a;if(l&&void 0!==l.deletedCount){const e=l.deletedCount||0,a=l.deletedUserIds||[];e>0?(H.value=H.value.filter(e=>!a.includes(e.id)),se.value=Math.max(0,se.value-e),ue.value?.clearSelection(),te.value=[],z.success(`成功删除 ${e} 个用户`),0===H.value.length&&ne.value>1&&(ne.value=ne.value-1,ce())):z.warning("没有成功删除任何用户")}else z.error(`批量删除失败: ${l?.message||"未知错误"}`)}catch(a){z.error("批量删除失败: "+(a.message||"未知错误"))}},be=()=>{if(0===te.value.length)return void z.warning("请先勾选需要导出的用户");const e=e=>{const a=null==e?"":String(e),l=/[",\n]/.test(a),t=a.replace(/"/g,'""');return l?`"${t}"`:t},a=te.value.map(a=>[a.id,a.userName,a.tenantSuperAdmin?"超级管理员":"普通用户",a.department,a.email,1===a.status?"开通":0===a.status?"关闭":"待审核",a.createTime].map(e).join(",")),l="\ufeff"+[["用户ID","用户名","角色","部门","邮箱","状态","加入时间"].join(","),...a].join("\n"),t=new Blob([l],{type:"text/csv;charset=utf-8;"}),u=URL.createObjectURL(t),s=document.createElement("a"),n=(new Date).toISOString().replace(/[-:T]/g,"").slice(0,14);s.href=u,s.download=`users_export_${n}.csv`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(u)},he=()=>{ie.value=!ie.value};return(e,a)=>{const l=h("loading");return s(),d("div",ee,[r(f(O),{gutter:16},{default:n(()=>[r(f(L),{span:ie.value?1:4,class:"department-col"},{default:n(()=>[m("div",{class:"collapse-toggle",onClick:v(he,["stop"])},[r(f(R),null,{default:n(()=>[ie.value?(s(),u(f(w),{key:0})):(s(),u(f(k),{key:1}))]),_:1})]),ie.value?p("",!0):(s(),u(f(D),{key:0,"default-active":G.value,class:"el-menu-vertical-demo",onSelect:pe},{default:n(()=>[(s(!0),d(i,null,o(P.value,e=>(s(),u(f(B),{key:e.id,index:e.id.toString()},{default:n(()=>[m("span",null,_(e.name),1)]),_:2},1032,["index"]))),128))]),_:1},8,["default-active"]))]),_:1},8,["span"]),r(f(L),{span:ie.value?23:20},{default:n(()=>[r(f(O),{gutter:16,class:"filter-row"},{default:n(()=>[r(f(L),{span:4},{default:n(()=>[r(f(T),{placeholder:"请输入用户ID",modelValue:x.value.id,"onUpdate:modelValue":a[0]||(a[0]=e=>x.value.id=e),clearable:""},null,8,["modelValue"])]),_:1}),r(f(L),{span:4},{default:n(()=>[r(f(T),{placeholder:"请输入用户名",modelValue:x.value.userName,"onUpdate:modelValue":a[1]||(a[1]=e=>x.value.userName=e),clearable:""},null,8,["modelValue"])]),_:1}),r(f(L),{span:4},{default:n(()=>[r(f(q),{modelValue:x.value.tenantSuperAdmin,"onUpdate:modelValue":a[2]||(a[2]=e=>x.value.tenantSuperAdmin=e),placeholder:"选择角色",style:{width:"100%"}},{default:n(()=>[r(f(E),{label:"全部",value:null}),r(f(E),{label:"超级管理员",value:!0}),r(f(E),{label:"普通用户",value:!1})]),_:1},8,["modelValue"])]),_:1}),r(f(L),{span:4},{default:n(()=>[r(f(q),{modelValue:x.value.status,"onUpdate:modelValue":a[3]||(a[3]=e=>x.value.status=e),placeholder:"选择状态",style:{width:"100%"}},{default:n(()=>[r(f(E),{label:"全部",value:null}),r(f(E),{label:"开通",value:1}),r(f(E),{label:"关闭",value:0}),r(f(E),{label:"待审核",value:2})]),_:1},8,["modelValue"])]),_:1}),r(f(L),{span:4,class:"button-group"},{default:n(()=>[r(f(M),{type:"primary",onClick:ve},{default:n(()=>a[5]||(a[5]=[c("查询")])),_:1,__:[5]}),r(f(M),{onClick:fe},{default:n(()=>a[6]||(a[6]=[c("重置")])),_:1,__:[6]})]),_:1})]),_:1}),r(f(O),{class:"batch-actions",style:{"margin-top":"20px"}},{default:n(()=>[r(f(M),{type:"danger",onClick:S},{default:n(()=>a[7]||(a[7]=[c("新增")])),_:1,__:[7]}),r(Y,{ref_key:"createDialog",ref:t,onUserCreated:U},null,512),r(f(M),{type:"primary",onClick:I},{default:n(()=>a[8]||(a[8]=[c("批量导入")])),_:1,__:[8]}),r(Q,{ref_key:"batchImport",ref:g,onImportSuccess:ce},null,512),r(f(M),{type:"primary",disabled:0===te.value.length,onClick:ye},{default:n(()=>a[9]||(a[9]=[c("批量删除")])),_:1,__:[9]},8,["disabled"]),r(f(M),{type:"primary",disabled:0===te.value.length,onClick:be},{default:n(()=>a[10]||(a[10]=[c("用户导出")])),_:1,__:[10]},8,["disabled"])]),_:1}),C((s(),u(f(W),{ref_key:"tableRef",ref:ue,data:oe.value,style:{width:"100%"},stripe:"",onSelectionChange:_e,"row-style":{height:"50px"}},{empty:n(()=>[m("div",ae,[r(f(R),{style:{"font-size":"48px","margin-bottom":"16px"}},{default:n(()=>[r(f(V))]),_:1}),a[15]||(a[15]=m("p",null,"暂无数据",-1)),m("p",le,[a[14]||(a[14]=c(" 请尝试调整筛选条件或 ")),r(f(M),{link:"",onClick:fe},{default:n(()=>a[13]||(a[13]=[c("清除所有筛选")])),_:1,__:[13]})])])]),default:n(()=>[r(f(F),{type:"selection",width:"55"}),r(f(F),{prop:"id",label:"用户ID",width:"80"}),r(f(F),{prop:"userName",label:"用户名"}),r(f(F),{prop:"role",label:"角色",width:"120"},{default:n(({row:e})=>[r(f(X),{type:e.tenantSuperAdmin?"warning":"info"},{default:n(()=>[c(_(e.tenantSuperAdmin?"超级管理员":"普通用户"),1)]),_:2},1032,["type"])]),_:1}),r(f(F),{prop:"department",label:"所属部门"}),r(f(F),{prop:"email",label:"邮箱"}),r(f(F),{prop:"status",label:"状态",width:"100"},{default:n(({row:e})=>[r(f(X),{type:1===e.status?"success":0===e.status?"danger":"warning"},{default:n(()=>[c(_(1===e.status?"开通":0===e.status?"关闭":"待审核"),1)]),_:2},1032,["type"])]),_:1}),r(f(F),{prop:"createTime",label:"加入时间",width:"160"}),r(f(F),{label:"操作",width:"200"},{default:n(({row:e})=>[2!==e.status?(s(),u(f(M),{key:0,size:"small",type:"warning",onClick:a=>(e=>{const a=1===e.status?0:1,l=1===a?"开通":"关闭";Z.confirm(`确认${l}用户「${e.userName}」吗？`,"提示",{type:"warning"}).then(async()=>{try{await j(e.id,{status:a}),z.success(`用户已${l}`);const t=H.value.findIndex(a=>a.id===e.id);-1!==t&&(H.value[t]={...H.value[t],status:a})}catch(t){z.error(`${l}失败: ${t.message||"未知错误"}`)}}).catch(()=>{})})(e)},{default:n(()=>[c(_(1===e.status?"关闭":"开通"),1)]),_:2},1032,["onClick"])):p("",!0),2===e.status?(s(),u(f(M),{key:1,size:"small",type:"primary",onClick:a=>(e=>{Z.confirm(`确认审核通过用户「${e.userName}」吗？`,"提示",{type:"warning"}).then(async()=>{try{const a=await j(e.id,{status:1});z.success("用户审核通过");const l=a?.data||a;if(l){const a=H.value.findIndex(a=>a.id===e.id);-1!==a&&(H.value[a]={...H.value[a],...l})}else{const a=H.value.findIndex(a=>a.id===e.id);-1!==a&&(H.value[a]={...H.value[a],status:1})}}catch(a){z.error(`审核失败: ${a.message||"未知错误"}`)}}).catch(()=>{})})(e)},{default:n(()=>a[11]||(a[11]=[c(" 审核 ")])),_:2,__:[11]},1032,["onClick"])):p("",!0),r(f(M),{size:"small",type:"danger",onClick:a=>(e=>{Z.confirm(`确认删除用户「${e.userName}」吗？`,"提示",{type:"warning"}).then(async()=>{try{await N(e.id),z.success("已删除");const a=H.value.findIndex(a=>String(a.id)===String(e.id));-1!==a&&(H.value.splice(a,1),se.value=Math.max(0,se.value-1),0===H.value.length&&ne.value>1&&(ne.value=ne.value-1,ce()))}catch(a){z.error("删除失败: "+(a.message||"未知错误"))}}).catch(()=>{})})(e)},{default:n(()=>a[12]||(a[12]=[c("删除")])),_:2,__:[12]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[l,de.value]]),r(f(K),{"current-page":ne.value,"onUpdate:currentPage":a[4]||(a[4]=e=>ne.value=e),total:se.value,"page-size":re.value,layout:"total, prev, pager, next, jumper",onCurrentChange:ge},null,8,["current-page","total","page-size"])]),_:1},8,["span"])]),_:1})])}}},[["__scopeId","data-v-c781560a"]]);export{te as default};
