import"./index-8D9d6p3q.js";import{aR as e}from"./vendor-zcc-V1Og.js";import{r as t,a as n,F as a,a7 as o}from"./vue-vendor-BUDnSszI.js";function i(i=null){const s=t(null),r=t(!1),u=t(null),d=t(0);t(null);const l=n({list:[],unreadCount:0});function c(){try{const t=i||"ws://localhost:8081/ws/notifications";s.value=new WebSocket(t),s.value.onopen=()=>{r.value=!0,u.value=null,d.value=0},s.value.onmessage=t=>{try{!function(t){if(0===t.code&&Array.isArray(t.data))return void function(t){0===t.code&&Array.isArray(t.data)&&t.data.forEach(t=>{const n={id:t.id||Date.now(),knowledgeBaseName:t.knowledgeBaseName||"未知知识库",userName:t.userName||"未知用户",feedbackType:t.feedbackType||"工单通知",createdAt:t.createdAt||(new Date).toISOString(),type:t.type||"NEW",timestamp:new Date(t.createdAt||Date.now()).getTime()};l.list.unshift(n),l.unreadCount++,e({title:"新工单通知",message:`用户「${n.userName}」在知识库「${n.knowledgeBaseName}」中提交了工单`,type:"info",duration:5e3})})}(t);if(void 0!==t.id)return void function(t){const{id:n,knowledgeBaseName:a,userName:o,feedbackType:i,createdAt:s,type:r}=t;if(n&&r&&null===a&&null===o&&null===i&&null===s)return void function(t,n){const a=l.list.findIndex(e=>e.id===t);-1!==a&&(l.list[a].type=n,l.list[a].updatedAt=(new Date).toISOString(),l.list=[...l.list],e({title:"工单状态更新",message:`工单 #${t} 状态已更新为: ${f(n)}`,type:"PROCESSED"===n?"success":"info",duration:3e3}))}(n,r);if(n&&a&&o&&i&&s&&r)return void function(t){const n={id:t.id,knowledgeBaseName:t.knowledgeBaseName||"未知知识库",userName:t.userName||"未知用户",feedbackType:t.feedbackType||"工单通知",createdAt:t.createdAt||(new Date).toISOString(),type:t.type||"NEW",timestamp:new Date(t.createdAt||Date.now()).getTime()};-1===l.list.findIndex(e=>e.id===n.id)&&(l.list.unshift(n),l.unreadCount++,e({title:"新工单通知",message:`用户「${n.userName}」在知识库「${n.knowledgeBaseName}」中提交了工单`,type:"info",duration:5e3}))}(t)}(t)}(JSON.parse(t.data))}catch(n){}},s.value.onerror=t=>{u.value=t,r.value=!1,e.error({title:"WebSocket 连接错误",message:"无法连接到工单通知服务，请检查网络连接或联系管理员"})},s.value.onclose=t=>{r.value=!1,1e3!==t.code&&e.warning({title:"连接断开",message:`WebSocket连接已断开 (代码: ${t.code})`})}}catch(t){u.value=t}}function f(e){return"NEW"===e?"新工单":"PROCESSED"===e?"已处理":e||"未知状态"}function m(){s.value&&s.value.close(1e3,"Manual disconnect")}return a(()=>{c()}),o(()=>{m()}),{socket:s,isConnected:r,notifications:l,error:u,connect:c,disconnect:m,markNotificationAsRead:function(e){l.unreadCount>0&&l.unreadCount--},clearAllNotifications:function(){l.list=[],l.unreadCount=0}}}export{i as u};
