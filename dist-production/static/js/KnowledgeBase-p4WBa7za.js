import{bY as e,r as a,w as l,a as t,b1 as u,U as i,J as s,V as n,a1 as r,X as o,I as d,a0 as c,av as p,Z as v,K as m,u as g,bb as _,br as f,$ as b,n as y,F as h,bh as w,W as k,bE as C,as as V,d as S,au as x,bT as z,bU as U,b_ as N,aa as O,c8 as I,c9 as B,ca as j,bX as A,ae as T,bS as q,aG as E,Y as R}from"./vue-vendor-BUDnSszI.js";import{b as D,u as F,e as L,f as $,h as P,i as K,j as M,k as Y,l as J,m as G,n as X,o as W,p as Z,q as H,r as Q,s as ee,t as ae,v as le,w as te,x as ue,y as ie,z as se}from"./kb-DvJy3p-L.js";import{_ as ne}from"./_plugin-vue_export-helper-BCo6x5W8.js";import{aL as re,aK as oe,aS as de,aT as ce}from"./vendor-zcc-V1Og.js";import{u as pe,g as ve}from"./index-8D9d6p3q.js";import"./network-vendor-ztdpVPaQ.js";const me={key:3,class:"custom-init-params"},ge={class:"params-section"},_e={class:"params-grid"},fe={class:"param-item"},be={class:"param-item"},ye={class:"param-item full-width"},he={class:"description-content"},we=["src"],ke={class:"dialog-footer"},Ce=ne({__name:"CreateData",props:{visible:{type:Boolean,required:!0}},emits:["update:visible","add"],setup(h,{emit:w}){const k=e(),C=h,V=w,S=a(!1);l(()=>C.visible,e=>{S.value=e}),l(S,e=>{V("update:visible",e)});const x=()=>{R.value?oe.confirm("正在提交中，确定要关闭吗？","提示",{type:"warning"}).then(()=>{V("update:visible",!1),H()}).catch(()=>{}):(V("update:visible",!1),H())},z=a(null),U=a(null),N=a(null),O=a(null),I=a([]),B=a([]),j=a([]),A=a(!1),T=a(""),q=t({type:"document",initStrategy:"smart",customConfig:{chunkSize:1e3,chunkOverlap:200,separator:"\n\n"}}),E=a(k.params.id||k.path.split("/").pop()),R=a(!1),F=[{label:"文档",value:"document"},{label:"图片",value:"image"},{label:"音视频",value:"media"}],L={type:[{required:!0,message:"请选择数据源类型",trigger:"change"}],files:[{validator:(e,a,l)=>{"document"===q.type&&0===I.value.length?l(new Error("请至少选择一个文件")):l()},trigger:["change","blur"]}],images:[{validator:(e,a,l)=>{"image"===q.type&&0===B.value.length?l(new Error("请至少选择一张图片")):l()},trigger:["change","blur"]}],media:[{validator:(e,a,l)=>{"media"===q.type&&0===j.value.length?l(new Error("请至少选择一个音视频文件")):l()},trigger:["change","blur"]}],initStrategy:[{required:!0,message:"请选择初始化策略",trigger:"change"}]},$=e=>{"document"===e?(B.value=[],j.value=[],N.value&&N.value.clearFiles(),O.value&&O.value.clearFiles()):"image"===e?(I.value=[],j.value=[],U.value&&U.value.clearFiles(),O.value&&O.value.clearFiles()):"media"===e&&(I.value=[],B.value=[],U.value&&U.value.clearFiles(),N.value&&N.value.clearFiles())},P=e=>{},K=()=>{const e="document"===q.type?5:"image"===q.type?10:5;re.warning(`最多上传 ${e} 个文件`)},M=e=>{const a=e.name.split(".").pop().toLowerCase(),l=e.size/1024/1024<2;return["pdf","doc","docx","txt"].includes(a)?!!l||(re.error("文件大小不能超过 2MB"),!1):(re.error(`不支持 ${a} 格式的文件`),!1)},Y=e=>{const a=e.name.split(".").pop().toLowerCase(),l=e.size/1024/1024<5;return["jpg","jpeg","png","gif","bmp","webp"].includes(a)?!!l||(re.error("图片大小不能超过 5MB"),!1):(re.error(`不支持 ${a} 格式的图片`),!1)},J=e=>{const a=e.name.split(".").pop().toLowerCase(),l=e.size/1024/1024<50;return["mp3","wav","ogg","mp4","avi","mov","wmv","flv","mkv"].includes(a)?!!l||(re.error("音视频文件大小不能超过 50MB"),!1):(re.error(`不支持 ${a} 格式的音视频文件`),!1)},G=(e,a)=>{I.value=a},X=(e,a)=>{B.value=a},W=(e,a)=>{j.value=a},Z=e=>{T.value=e.url,A.value=!0},H=()=>{q.type="document",q.initStrategy="smart",q.customConfig={chunkSize:1e3,chunkOverlap:200,separator:"\n\n"},I.value=[],B.value=[],j.value=[],U.value&&U.value.clearFiles(),N.value&&N.value.clearFiles(),O.value&&O.value.clearFiles()},Q=async()=>{if(!R.value)try{await z.value.validate(),R.value=!0;const e=new FormData;e.append("knowledge_base_id",E.value),e.append("type",q.type);const a={smart:0,default:1,custom:2}[q.initStrategy];if(void 0===a)return void re.error("无效的初始化策略");if(e.append("init_strategy_type",a),"custom"===q.initStrategy){const a={chunk_size:q.customConfig.chunkSize,chunk_overlap:q.customConfig.chunkOverlap,separator:q.customConfig.separator};e.append("custom_config",JSON.stringify(a))}if("document"===q.type){if(0===I.value.length)return void re.error("请至少选择一个文件");I.value.forEach(a=>{e.append("files",a.raw)})}else if("image"===q.type){if(0===B.value.length)return void re.error("请至少选择一张图片");B.value.forEach(a=>{e.append("images",a.raw)})}else if("media"===q.type){if(0===j.value.length)return void re.error("请至少选择一个音视频文件");j.value.forEach(a=>{e.append("media_files",a.raw)})}const l=await D(E.value,e);l?(V("add",{type:q.type,initStrategy:q.initStrategy,customConfig:"custom"===q.initStrategy?q.customConfig:null,data:l.data||l}),S.value=!1,H()):re.error(`创建数据源失败: ${l.message||"未知错误"}`)}catch(e){re.error(e.message||"提交失败")}finally{R.value=!1}};return l(S,e=>{e&&y(()=>{U.value,N.value,O.value})}),(e,a)=>{const l=u("el-option"),t=u("el-select"),y=u("el-form-item"),h=u("el-button"),w=u("el-upload"),k=u("el-icon"),C=u("el-radio"),V=u("el-radio-group"),E=u("el-input-number"),D=u("el-input"),H=u("el-form"),ee=u("el-dialog");return s(),i(ee,{title:"添加数据源",modelValue:S.value,"onUpdate:modelValue":a[7]||(a[7]=e=>S.value=e),width:"600px",onClose:x},{footer:n(()=>[m("div",ke,[r(h,{onClick:x,disabled:R.value},{default:n(()=>a[24]||(a[24]=[v("取消")])),_:1,__:[24]},8,["disabled"]),r(h,{type:"primary",onClick:Q,loading:R.value},{default:n(()=>[v(b(R.value?"提交中...":"确定"),1)]),_:1},8,["loading"])])]),default:n(()=>[r(H,{ref_key:"formRef",ref:z,model:q,rules:L,"label-width":"100px"},{default:n(()=>[r(y,{label:"数据源类型",prop:"type"},{default:n(()=>[r(t,{modelValue:q.type,"onUpdate:modelValue":a[0]||(a[0]=e=>q.type=e),placeholder:"请选择类型",style:{width:"100%"},onChange:$},{default:n(()=>[(s(),d(c,null,p(F,e=>r(l,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),"document"===q.type?(s(),i(y,{key:0,label:"上传文件",prop:"files"},{default:n(()=>[r(w,{ref_key:"uploadRef",ref:U,"file-list":I.value,limit:5,"on-exceed":K,"on-change":G,"before-upload":M,multiple:"","auto-upload":!1},{tip:n(()=>a[9]||(a[9]=[m("div",{class:"el-upload__tip"}," 支持扩展名：.pdf .doc .docx .txt 等，单个文件大小不超过 2MB ",-1)])),default:n(()=>[r(h,{size:"small",type:"primary"},{default:n(()=>a[8]||(a[8]=[v("选择文件")])),_:1,__:[8]})]),_:1},8,["file-list"])]),_:1})):o("",!0),"image"===q.type?(s(),i(y,{key:1,label:"上传图片",prop:"images"},{default:n(()=>[r(w,{ref_key:"imageUploadRef",ref:N,"file-list":B.value,limit:10,"on-exceed":K,"on-change":X,"before-upload":Y,multiple:"","auto-upload":!1,"list-type":"picture-card","on-preview":Z},{tip:n(()=>a[10]||(a[10]=[m("div",{class:"el-upload__tip"}," 支持扩展名：.jpg .jpeg .png .gif .bmp 等，单个图片大小不超过 5MB ",-1)])),default:n(()=>[r(k,null,{default:n(()=>[r(g(_))]),_:1})]),_:1},8,["file-list"])]),_:1})):o("",!0),"media"===q.type?(s(),i(y,{key:2,label:"上传音视频",prop:"media",rules:L.media},{default:n(()=>[r(w,{ref_key:"mediaUploadRef",ref:O,"file-list":j.value,"onUpdate:fileList":a[1]||(a[1]=e=>j.value=e),action:"",multiple:!0,limit:5,"on-exceed":K,"before-upload":J,"on-change":W,"auto-upload":!1,"list-type":"text",accept:".mp3,.wav,.ogg,.mp4,.avi,.mov,.wmv,.flv,.mkv"},{tip:n(()=>a[12]||(a[12]=[m("div",{class:"el-upload__tip"}," 支持 mp3, wav, ogg, mp4, avi, mov, wmv, flv, mkv 格式，单个文件不超过 50MB ",-1)])),default:n(()=>[r(h,{type:"primary",icon:g(_)},{default:n(()=>a[11]||(a[11]=[v("选择音视频文件")])),_:1,__:[11]},8,["icon"])]),_:1},8,["file-list"])]),_:1},8,["rules"])):o("",!0),r(y,{label:"初始化策略",prop:"initStrategy"},{default:n(()=>[r(V,{modelValue:q.initStrategy,"onUpdate:modelValue":a[2]||(a[2]=e=>q.initStrategy=e),onChange:P},{default:n(()=>[r(C,{value:"smart"},{default:n(()=>a[13]||(a[13]=[v("智能初始化")])),_:1,__:[13]}),r(C,{value:"default"},{default:n(()=>a[14]||(a[14]=[v("默认初始化")])),_:1,__:[14]}),r(C,{value:"custom"},{default:n(()=>a[15]||(a[15]=[v("自定义初始化")])),_:1,__:[15]})]),_:1},8,["modelValue"])]),_:1}),"custom"===q.initStrategy?(s(),d("div",me,[m("div",ge,[a[21]||(a[21]=m("h4",{class:"params-title"},"自定义初始化参数",-1)),m("div",_e,[m("div",fe,[a[16]||(a[16]=m("label",{class:"param-label"},"分块大小",-1)),r(E,{modelValue:q.customConfig.chunkSize,"onUpdate:modelValue":a[3]||(a[3]=e=>q.customConfig.chunkSize=e),min:100,max:5e3,step:100,size:"small"},null,8,["modelValue"]),a[17]||(a[17]=m("span",{class:"param-desc"},"字符数",-1))]),m("div",be,[a[18]||(a[18]=m("label",{class:"param-label"},"重叠大小",-1)),r(E,{modelValue:q.customConfig.chunkOverlap,"onUpdate:modelValue":a[4]||(a[4]=e=>q.customConfig.chunkOverlap=e),min:0,max:1e3,step:50,size:"small"},null,8,["modelValue"]),a[19]||(a[19]=m("span",{class:"param-desc"},"字符数",-1))]),m("div",ye,[a[20]||(a[20]=m("label",{class:"param-label"},"分隔符",-1)),r(D,{modelValue:q.customConfig.separator,"onUpdate:modelValue":a[5]||(a[5]=e=>q.customConfig.separator=e),placeholder:"例如：\\n\\n",size:"small"},null,8,["modelValue"])])])])])):o("",!0),"custom"!==q.initStrategy?(s(),i(y,{key:4,class:"strategy-description"},{default:n(()=>[m("div",he,["smart"===q.initStrategy?(s(),d(c,{key:0},[r(k,null,{default:n(()=>[r(g(f))]),_:1}),a[22]||(a[22]=m("span",null,"智能初始化将自动分析内容，智能选择最佳的分块策略和参数",-1))],64)):"default"===q.initStrategy?(s(),d(c,{key:1},[r(k,null,{default:n(()=>[r(g(f))]),_:1}),a[23]||(a[23]=m("span",null,"使用本知识库默认参数进行初始化",-1))],64)):o("",!0)])]),_:1})):o("",!0)]),_:1},8,["model"]),r(ee,{modelValue:A.value,"onUpdate:modelValue":a[6]||(a[6]=e=>A.value=e),title:"图片预览",width:"60%"},{default:n(()=>[m("img",{"w-full":"",src:T.value,alt:"Preview Image",style:{"max-width":"100%"}},null,8,we)]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])}}},[["__scopeId","data-v-0273ace4"]]),Ve={class:"data-source-tab"},Se={class:"header"},xe={class:"action-bar"},ze={key:0,class:"pagination"},Ue={key:1,class:"empty-state"},Ne=ne({__name:"DataSourceTab",setup(t){const c=e().params.id,p=a([]),_=a(!1),f=a(!1),y=a(""),S=a(1),x=a(10),z=a(0);let U=null;const N=F(),O=()=>{const e=N.userRole;return 1===e||2===e||3===e},I=async()=>{try{_.value=!0;const e={page:S.value,page_size:x.value};y.value.trim()&&(e.search=y.value.trim());const a=await L(c,e);p.value=(a.items||a||[]).map(e=>({...e,deleting:!1,syncing:!1})),z.value=a.total||(a.items?a.items.length:a.length)||0}catch(e){re.error("获取数据源列表失败: "+(e.message||"未知错误")),p.value=[],z.value=0}finally{_.value=!1}};l(y,e=>{U&&clearTimeout(U),U=setTimeout(()=>{S.value=1,I()},500)});const B=()=>{S.value=1,I()},j=()=>{S.value=1,I()},A=e=>{S.value=e,I()},T=e=>{x.value=e,S.value=1,I()},q=()=>{I()},E=()=>{f.value=!0},R=async()=>{try{re.success("数据源添加成功"),S.value=1,await I()}catch(e){re.error("添加数据源失败: "+(e.message||"未知错误"))}},D=e=>({DONE:"完成",TODO:"待处理",PROCESSING:"处理中",FAILED:"失败"}[e]||e);return h(I),(e,a)=>{const l=u("el-icon"),t=u("el-input"),h=u("el-button"),U=u("el-table-column"),N=u("el-tag"),F=u("el-table"),L=u("el-pagination"),K=u("el-empty"),M=w("loading");return s(),d("div",Ve,[m("div",Se,[r(t,{modelValue:y.value,"onUpdate:modelValue":a[0]||(a[0]=e=>y.value=e),placeholder:"搜索数据源名称、类型或上传人",class:"pill-input search-input",clearable:"",onClear:j,onKeyup:V(B,["enter"])},{prefix:n(()=>[r(l,null,{default:n(()=>[r(g(C))]),_:1})]),_:1},8,["modelValue"]),m("div",xe,[O()?(s(),i(h,{key:0,type:"primary",onClick:E},{default:n(()=>a[4]||(a[4]=[v(" + 添加数据源 ")])),_:1,__:[4]})):o("",!0),r(h,{onClick:q,loading:_.value},{default:n(()=>a[5]||(a[5]=[v("刷新")])),_:1,__:[5]},8,["loading"])])]),k((s(),i(F,{data:p.value,stripe:"",style:{width:"100%"}},{default:n(()=>[r(U,{prop:"name",label:"名称"}),r(U,{prop:"file_type",label:"类型"},{default:n(({row:e})=>{return[r(N,{type:(a=e.file_type,{pdf:"primary",csv:"success",docx:"info",txt:"warning",xlsx:"success",doc:"info",ppt:"warning",pptx:"warning"}[a]||"info")},{default:n(()=>[v(b(e.file_type.toUpperCase()),1)]),_:2},1032,["type"])];var a}),_:1}),r(U,{prop:"uploader_name",label:"上传人"}),r(U,{prop:"updated_time",label:"更新时间"},{default:n(({row:e})=>{return[v(b((a=e.updated_time,new Date(a).toLocaleString())),1)];var a}),_:1}),r(U,{prop:"status",label:"状态"},{default:n(({row:e})=>{return[r(N,{type:(a=e.status,{DONE:"success",TODO:"info",PROCESSING:"warning",FAILED:"danger"}[a]||"info")},{default:n(()=>[v(b(D(e.status)),1)]),_:2},1032,["type"])];var a}),_:1}),r(U,{label:"操作",width:"260"},{default:n(({row:e})=>[r(h,{size:"small",text:"",onClick:a=>(async e=>{try{const a=(await $(c,e.id)).url;a?(window.open(a,"_blank"),re.success("文件链接获取成功")):re.warning("未找到有效的下载链接")}catch(a){re.error("获取文件链接失败: "+(a.message||"未知错误"))}})(e)},{default:n(()=>[r(l,null,{default:n(()=>[r(g(C))]),_:1}),a[6]||(a[6]=v(" 查看内容 "))]),_:2,__:[6]},1032,["onClick"]),O()?(s(),i(h,{key:0,size:"small",text:"",onClick:e=>{}},{default:n(()=>a[7]||(a[7]=[v(" 编辑 ")])),_:2,__:[7]},1032,["onClick"])):o("",!0),O()?(s(),i(h,{key:1,size:"small",text:"",type:"danger",onClick:a=>(e=>{oe.confirm("确定删除该数据源吗？","警告",{type:"warning",confirmButtonText:"确定",cancelButtonText:"取消"}).then(async()=>{try{e.deleting=!0,await P(c,e.id),re.success("删除成功"),await I()}catch(a){re.error("删除失败: "+a.message)}finally{e.deleting=!1}}).catch(()=>{})})(e),loading:e.deleting},{default:n(()=>a[8]||(a[8]=[v(" 删除 ")])),_:2,__:[8]},1032,["onClick","loading"])):o("",!0)]),_:1})]),_:1},8,["data"])),[[M,_.value]]),z.value>0?(s(),d("div",ze,[r(L,{"current-page":S.value,"onUpdate:currentPage":a[1]||(a[1]=e=>S.value=e),"page-size":x.value,"onUpdate:pageSize":a[2]||(a[2]=e=>x.value=e),total:z.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:A,onSizeChange:T},null,8,["current-page","page-size","total"])])):o("",!0),0!==p.value.length||_.value?o("",!0):(s(),d("div",Ue,[r(K,{description:y.value?"未找到匹配的数据源":"暂无数据源"},null,8,["description"])])),r(Ce,{visible:f.value,"onUpdate:visible":a[3]||(a[3]=e=>f.value=e),onAdd:R,"knowledge-base-id":g(c)},null,8,["visible","knowledge-base-id"])])}}},[["__scopeId","data-v-a967f322"]]),Oe={class:"user-selector"},Ie={class:"search-results"},Be={class:"user-info"},je={class:"user-details"},Ae={class:"user-name"},Te={class:"user-meta"},qe={class:"user-email"},Ee={key:0,class:"loading-state"},Re={key:0,class:"selected-count"},De={class:"action-footer"},Fe=ne({__name:"UserSelector",props:{excludeUsers:{type:Array,default:()=>[]},initialSelectedUsers:{type:Array,default:()=>[]}},emits:["select","cancel"],setup(e,{emit:t}){const _=e,f=t,y=pe(),w=a(""),k=a([]),V=a([]),z=a(!1);l(()=>_.initialSelectedUsers,e=>{Array.isArray(e)&&e.length>0?V.value=e.map(e=>String(e.id)):V.value=[]},{immediate:!0});const U=S(()=>{const e=new Set(_.excludeUsers.map(String)),a=(w.value||"").toLowerCase();return k.value.filter(l=>{const t=String(l.id);if(V.value.includes(t))return!0;if(e.has(t))return!1;const u=(l.userName||"").toLowerCase(),i=(l.email||"").toLowerCase();return!a||u.includes(a)||i.includes(a)})}),N=()=>{},O=()=>{const e=new Set(V.value.map(String)),a=k.value.filter(a=>e.has(String(a.id)));f("select",a)},I=()=>f("cancel");return h(()=>{(async()=>{try{z.value=!0;const e=y?.tenantId;if(!e)return void re.error("无法获取租户信息");const a=await ve(e),l=a?.items??[];k.value=l.filter(e=>1===Number(e.status)).map(e=>({id:Number(e.id),userName:e.userName||"",email:e.email||"",status:Number(e.status),avatar:e.avatar||""}))}catch(e){re.error("获取用户列表失败: "+(e.message||"未知错误")),k.value=[]}finally{z.value=!1}})()}),(e,a)=>{const l=u("el-icon"),t=u("el-input"),f=u("el-avatar"),y=u("el-tag"),h=u("el-checkbox"),k=u("el-checkbox-group"),S=u("el-empty"),B=u("el-button");return s(),d("div",Oe,[r(t,{modelValue:w.value,"onUpdate:modelValue":a[0]||(a[0]=e=>w.value=e),placeholder:"搜索用户",clearable:"",onInput:N},{prefix:n(()=>[r(l,null,{default:n(()=>[r(g(C))]),_:1})]),_:1},8,["modelValue"]),m("div",Ie,[r(k,{modelValue:V.value,"onUpdate:modelValue":a[1]||(a[1]=e=>V.value=e)},{default:n(()=>[(s(!0),d(c,null,p(U.value,e=>{return s(),d("div",{key:e.id,class:"user-item"},[r(h,{label:String(e.id),disabled:(a=e.id,_.excludeUsers.map(String).includes(String(a)))},{default:n(()=>[m("div",Be,[r(f,{size:32,src:e.avatar||""},null,8,["src"]),m("div",je,[m("div",Ae,b(e.userName),1),m("div",Te,[m("span",qe,b(e.email),1),r(y,{type:1===e.status?"success":"danger",size:"small"},{default:n(()=>[v(b(1===e.status?"启用":"禁用"),1)]),_:2},1032,["type"])])])])]),_:2},1032,["label","disabled"])]);var a}),128))]),_:1},8,["modelValue"]),z.value?(s(),d("div",Ee,[r(l,{class:"loading-icon"},{default:n(()=>[r(g(x))]),_:1}),a[2]||(a[2]=m("span",null,"加载中...",-1))])):0===U.value.length&&w.value?(s(),i(S,{key:1,description:"未找到相关用户"})):0===U.value.length?(s(),i(S,{key:2,description:"暂无用户数据"})):o("",!0)]),V.value.length>0?(s(),d("div",Re," 已选择 "+b(V.value.length)+" 个用户 ",1)):o("",!0),m("div",De,[r(B,{onClick:I},{default:n(()=>a[3]||(a[3]=[v("取消")])),_:1,__:[3]}),r(B,{type:"primary",onClick:O,disabled:0===V.value.length},{default:n(()=>a[4]||(a[4]=[v("确认")])),_:1,__:[4]},8,["disabled"])])])}}},[["__scopeId","data-v-59a560f2"]]),Le={class:"permission-tab"},$e={class:"access-control-section"},Pe={class:"section-header"},Ke={key:0,class:"access-hint"},Me={key:1,class:"access-hint"},Ye={class:"permission-management"},Je={class:"permission-section"},Ge={class:"section-title"},Xe={class:"user-list"},We={key:2,class:"no-permission-hint"},Ze={class:"permission-section"},He={class:"section-title"},Qe={class:"user-list"},ea={key:0,class:"permission-section"},aa={class:"section-title"},la={class:"user-list"},ta={class:"action-footer"},ua=ne({__name:"PermissionTab",setup(l){const t=e(),_=F(),f=a(1),y=a(null),w=a([]),k=a([]),C=a(null),V=a(!1),x=a(!1),I=a(!1),B=a(""),j=a([]),A=a(0),T={owner:"所有者",admin:"管理员",member:"成员"},q=S(()=>_.userRole),E=S(()=>3===q.value),R=S(()=>2===q.value),D=S(()=>1===q.value),L=S(()=>E.value||R.value),$=S(()=>E.value||R.value),P=S(()=>E.value||R.value||D.value),Y=S(()=>E.value||R.value||D.value),J=S(()=>E.value||R.value||D.value),G=S(()=>[...y.value?.id?[y.value.id]:[],...w.value.map(e=>e.id),...k.value.map(e=>e.id)].map(e=>String(e))),X=S(()=>{if(!C.value)return!1;return JSON.stringify(W())!==C.value});function W(){const e=e=>[...e].sort((e,a)=>Number(e.id)-Number(a.id));return{access_mode:f.value,owner:y.value?{id:y.value.id,name:y.value.name}:null,admins:e(w.value),members:0===f.value?e(k.value):[]}}const Z=async()=>{if(y.value?.id)try{x.value=!0;const e=0===f.value?k.value:[];await M(t.params.id,{access_mode:f.value,user_roles:{owner:Number(y.value.id),admins:w.value.map(e=>Number(e.id)),members:e.map(e=>Number("object"==typeof e?e.id:e))}}),k.value=e,C.value=JSON.stringify(W()),re.success("权限更新成功")}catch(e){re.error("保存权限失败: "+(e.response?.data?.message||e.message))}finally{x.value=!1}else re.warning("必须指定所有者")},H=async e=>{if(1===e){if(!y.value)return re.warning("公开知识库必须指定一名所有者"),void(f.value=0);if(k.value.length){if(!(await oe.confirm("切换为公开将清空访问成员列表，是否继续？","确认",{type:"warning"}).catch(()=>!1)))return void(f.value=0)}k.value=[]}},Q=e=>{"owner"!==e||$.value?"admin"!==e||P.value?"member"!==e||Y.value?(B.value=e,j.value="admin"===e?[...w.value]:"member"===e?[...k.value]:[],A.value++,I.value=!0):re.warning("您没有权限管理成员"):re.warning("您没有权限管理管理员"):re.warning("您没有权限更改所有者")},ee=e=>{const a=new Set(e.map(e=>Number(e.id))),l=e.map(e=>({id:Number(e.id),name:e.userName,avatar:e.avatar}));if("owner"===B.value){const e=l[0];e&&(y.value=e,w.value=w.value.filter(e=>e.id!==y.value.id),k.value=k.value.filter(e=>e.id!==y.value.id))}else"admin"===B.value?(w.value=l,k.value=k.value.filter(e=>!a.has(e.id))):"member"===B.value&&(k.value=l,w.value=w.value.filter(e=>!a.has(e.id)));I.value=!1},ae=async(e,a)=>{if("owner"!==e)if("admin"!==e||P.value)if("member"!==e||Y.value)try{await oe.confirm(`确定要移除该${T[e]}吗?`,"提示",{type:"warning"}),"admin"===e?w.value=w.value.filter(e=>e.id!==a):"member"===e&&(k.value=k.value.filter(e=>e.id!==a))}catch{}else re.warning("您没有权限移除成员");else re.warning("您没有权限移除管理员");else re.warning("请使用“更换所有者”来修改所有者")},le=()=>{j.value=[]};return h(()=>{(async()=>{try{V.value=!0;const e=await K(t.params.id),a=e.data||e;f.value=a.access_mode??0,y.value=a.owner?{id:Number(a.owner.id),name:a.owner.name,avatar:a.owner.avatar??0}:null,w.value=(a.admins??[]).map(e=>({id:Number(e.id),name:e.name,avatar:e.avatar??0})),k.value=(a.members??[]).map(e=>({id:Number(e.id),name:e.name,avatar:e.avatar??0})),C.value=JSON.stringify(W())}catch(e){re.error("获取权限失败: "+(e.response?.data?.message||e.message)),y.value=null,w.value=[],k.value=[]}finally{V.value=!1}})()}),(e,a)=>{const l=u("el-radio"),t=u("el-radio-group"),_=u("el-alert"),h=u("el-icon"),C=u("el-tag"),V=u("el-button"),S=u("el-dialog");return s(),d("div",Le,[m("div",$e,[m("div",Pe,[a[8]||(a[8]=m("h3",null,"知识库访问权限",-1)),r(t,{modelValue:f.value,"onUpdate:modelValue":a[0]||(a[0]=e=>f.value=e),onChange:H,disabled:!L.value},{default:n(()=>[r(l,{label:1},{default:n(()=>a[6]||(a[6]=[v("公开")])),_:1,__:[6]}),r(l,{label:0},{default:n(()=>a[7]||(a[7]=[v("私有")])),_:1,__:[7]})]),_:1},8,["modelValue","disabled"])]),0===f.value?(s(),d("div",Ke,[r(_,{type:"info",closable:!1},{default:n(()=>a[9]||(a[9]=[v(" 私有知识库仅限以下指定人员访问 ")])),_:1,__:[9]})])):(s(),d("div",Me,[r(_,{type:"success",closable:!1},{default:n(()=>a[10]||(a[10]=[v(" 公开知识库对所有用户可见，但编辑仍需权限 ")])),_:1,__:[10]})]))]),m("div",Ye,[m("div",Je,[m("div",Ge,[r(h,null,{default:n(()=>[r(g(z))]),_:1}),a[11]||(a[11]=m("span",null,"所有者",-1))]),m("div",Xe,[y.value&&y.value.id?(s(),i(C,{key:y.value.id,type:"danger",closable:!1},{default:n(()=>[v(b(y.value.name),1)]),_:1})):o("",!0),$.value?(s(),i(V,{key:1,type:"primary",size:"small",onClick:a[1]||(a[1]=e=>Q("owner"))},{default:n(()=>[v(b(y.value&&y.value.id?"更换所有者":"+ 添加所有者"),1)]),_:1})):(s(),d("div",We,[r(h,null,{default:n(()=>[r(g(U))]),_:1}),a[12]||(a[12]=m("span",null,"只有所有者或超级管理员可以更改所有者",-1))]))]),a[13]||(a[13]=m("p",{class:"hint-text"},"所有者拥有最高权限，可修改知识库设置",-1))]),m("div",Ze,[m("div",He,[r(h,null,{default:n(()=>[r(g(N))]),_:1}),a[14]||(a[14]=m("span",null,"管理员",-1))]),m("div",Qe,[(s(!0),d(c,null,p(w.value,e=>(s(),i(C,{key:e.id,type:"warning",closable:P.value,onClose:a=>ae("admin",e.id)},{default:n(()=>[v(b(e.name),1)]),_:2},1032,["closable","onClose"]))),128)),P.value?(s(),i(V,{key:0,type:"primary",size:"small",onClick:a[2]||(a[2]=e=>Q("admin"))},{default:n(()=>a[15]||(a[15]=[v(" + 添加管理员 ")])),_:1,__:[15]})):o("",!0)]),a[16]||(a[16]=m("p",{class:"hint-text"},"管理员可编辑知识库内容",-1))]),0===f.value?(s(),d("div",ea,[m("div",aa,[r(h,null,{default:n(()=>[r(g(O))]),_:1}),a[17]||(a[17]=m("span",null,"访问成员",-1))]),m("div",la,[(s(!0),d(c,null,p(k.value,e=>(s(),i(C,{key:e.id,closable:Y.value,onClose:a=>ae("member",e.id)},{default:n(()=>[v(b(e.name),1)]),_:2},1032,["closable","onClose"]))),128)),Y.value?(s(),i(V,{key:0,type:"primary",size:"small",onClick:a[3]||(a[3]=e=>Q("member"))},{default:n(()=>a[18]||(a[18]=[v(" + 添加成员 ")])),_:1,__:[18]})):o("",!0)]),a[19]||(a[19]=m("p",{class:"hint-text"},"私有知识库的指定访问人员",-1))])):o("",!0)]),m("div",ta,[r(V,{type:"primary",loading:x.value,onClick:Z,disabled:!X.value||!J.value||!y.value?.id},{default:n(()=>a[20]||(a[20]=[v(" 保存更改 ")])),_:1,__:[20]},8,["loading","disabled"])]),r(S,{modelValue:I.value,"onUpdate:modelValue":a[5]||(a[5]=e=>I.value=e),title:`添加${T[B.value]}`,width:"600px",onClosed:le},{default:n(()=>[(s(),i(Fe,{key:A.value,"exclude-users":G.value,"initial-selected-users":j.value,onSelect:ee,onCancel:a[4]||(a[4]=e=>I.value=!1)},null,8,["exclude-users","initial-selected-users"]))]),_:1},8,["modelValue","title"])])}}},[["__scopeId","data-v-d5a32d8b"]]),ia={class:"log-tab"},sa={class:"filter-section"},na={class:"section"},ra={class:"pagination"},oa=ne({__name:"LogTab",setup(l){const t=e(),o=a([]),_=a(!1),f=a(0),y=a({operator:"",action:"",timeRange:[],page:1,pageSize:20}),V={create:"创建",update:"更新",delete:"删除",permission:"权限变更",upload:"上传"},S=e=>V[e]||"未知操作",x=(e=!0)=>{const a={operator:y.value.operator,action:y.value.action,start_time:y.value.timeRange?.[0],end_time:y.value.timeRange?.[1]};return e&&(a.page=y.value.page,a.pageSize=y.value.pageSize),a},z=async()=>{try{_.value=!0;const e=x(!0),a=await Y(t.params.id,e);let l=[],u=0;Array.isArray(a)?(l=a,u=a.length):a?.data?.items?(l=a.data.items,u=a.data.total||a.data.items.length):a?.data?.data?(l=a.data.data,u=a.data.total||a.data.data.length):Array.isArray(a?.data)?(l=a.data,u=a.total||a.data.length):re.warning("获取日志数据格式异常"),o.value=l.map(e=>({timestamp:e.create_time||e.createTime||e.timestamp||"N/A",operator:e.operator_name||e.operator||e.operator_id||"未知用户",action:e.action_type||e.action||"unknown",description:e.action_detail||e.description||"无描述"})),f.value=u}catch(e){re.error("获取日志失败: "+(e.message||"未知错误"))}finally{_.value=!1}},U=()=>{y.value.page=1,z()},N=()=>{y.value={operator:"",action:"",timeRange:[],page:1,pageSize:20},z()},O=async(e=!1)=>{try{_.value=!0;let a=[];if(e){const e=x(!1),l=await Y(e);let t=[];Array.isArray(l)?t=l:l?.data?.items?t=l.data.items:l?.data?.data?t=l.data.data:Array.isArray(l?.data)&&(t=l.data),a=t.map(e=>({timestamp:e.create_time||e.createTime||e.timestamp||"N/A",operator:e.operator_name||e.operator||e.operator_id||"未知用户",action:e.action_type||e.action||"unknown",description:e.action_detail||e.description||"无描述"}))}else a=o.value;if(0===a.length)return void re.warning("当前无数据可导出");const l=a.map(e=>({"时间":e.timestamp,"操作人":e.operator,"操作类型":S(e.action),"描述":e.description})),t=de.book_new(),u=de.json_to_sheet(l);u["!cols"]=[{wch:20},{wch:15},{wch:15},{wch:50}],de.book_append_sheet(t,u,"知识库操作日志");const i=`知识库操作日志_${e?"全部":"当前页"}_${(new Date).toISOString().split("T")[0]}.xlsx`;ce(t,i),re.success(`导出${e?"全部":"当前页"}成功`)}catch(a){re.error("导出失败: "+a.message)}finally{_.value=!1}};return h(()=>{z()}),(e,a)=>{const l=u("el-input"),t=u("el-form-item"),h=u("el-option"),x=u("el-select"),j=u("el-date-picker"),A=u("el-icon"),T=u("el-button"),q=u("el-form"),E=u("el-table-column"),R=u("el-tag"),D=u("el-table"),F=u("el-pagination"),L=w("loading");return s(),d("div",ia,[m("div",sa,[r(q,{model:y.value,inline:""},{default:n(()=>[r(t,{label:"操作人"},{default:n(()=>[r(l,{modelValue:y.value.operator,"onUpdate:modelValue":a[0]||(a[0]=e=>y.value.operator=e),placeholder:"请输入操作人",clearable:""},null,8,["modelValue"])]),_:1}),r(t,{label:"操作类型"},{default:n(()=>[r(x,{modelValue:y.value.action,"onUpdate:modelValue":a[1]||(a[1]=e=>y.value.action=e),placeholder:"请选择操作类型",clearable:""},{default:n(()=>[(s(),d(c,null,p(V,(e,a)=>r(h,{key:a,label:e,value:a},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),r(t,{label:"时间范围"},{default:n(()=>[r(j,{modelValue:y.value.timeRange,"onUpdate:modelValue":a[2]||(a[2]=e=>y.value.timeRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",clearable:""},null,8,["modelValue"])]),_:1}),r(t,null,{default:n(()=>[r(T,{type:"primary",onClick:U,loading:_.value},{default:n(()=>[r(A,null,{default:n(()=>[r(g(C))]),_:1}),a[7]||(a[7]=v("查询 "))]),_:1,__:[7]},8,["loading"]),r(T,{onClick:N},{default:n(()=>[r(A,null,{default:n(()=>[r(g(I))]),_:1}),a[8]||(a[8]=v("重置 "))]),_:1,__:[8]}),r(T,{type:"success",onClick:a[3]||(a[3]=e=>O(!1)),disabled:0===o.value.length},{default:n(()=>[r(A,null,{default:n(()=>[r(g(B))]),_:1}),a[9]||(a[9]=v("导出当前页 "))]),_:1,__:[9]},8,["disabled"]),r(T,{type:"warning",onClick:a[4]||(a[4]=e=>O(!0))},{default:n(()=>[r(A,null,{default:n(()=>[r(g(B))]),_:1}),a[10]||(a[10]=v("导出全部 "))]),_:1,__:[10]})]),_:1})]),_:1},8,["model"])]),m("div",na,[a[11]||(a[11]=m("div",{class:"section-title"},"知识库修改记录",-1)),k((s(),i(D,{data:o.value,stripe:"",style:{width:"100%"}},{default:n(()=>[r(E,{prop:"timestamp",label:"时间",width:"180",sortable:""}),r(E,{prop:"operator",label:"操作人",width:"120"}),r(E,{prop:"action",label:"操作类型",width:"120"},{default:n(({row:e})=>{return[r(R,{type:(a=e.action,{create:"success",update:"primary",delete:"danger",permission:"warning",upload:"info"}[a]||"")},{default:n(()=>[v(b(S(e.action)),1)]),_:2},1032,["type"])];var a}),_:1}),r(E,{prop:"description",label:"描述"})]),_:1},8,["data"])),[[L,_.value]]),m("div",ra,[r(F,{"current-page":y.value.page,"onUpdate:currentPage":a[5]||(a[5]=e=>y.value.page=e),"page-size":y.value.pageSize,"onUpdate:pageSize":a[6]||(a[6]=e=>y.value.pageSize=e),total:f.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:z,onCurrentChange:z},null,8,["current-page","page-size","total"])])])])}}},[["__scopeId","data-v-74f6c29b"]]),da={class:"params-tab"},ca={class:"section"},pa={class:"section-title"},va={class:"init-params"},ma={class:"param-description-card"},ga={class:"card-header"},_a={class:"footer"},fa=ne({__name:"ParamsTab",props:{knowledgeBaseId:{type:String,required:!0}},setup(e){const l=e,t=a(!1),i=a({chunkSize:1e3,chunkOverlap:200,separator:"\n\n",embedding_model:"text2vec-base"}),o=async()=>{try{const e=await J(l.knowledgeBaseId);e&&(i.value={chunkSize:e.chunkSize??1e3,chunkOverlap:e.chunkOverlap??200,separator:e.separator??"\n\n",embedding_model:e.embedding_model??"text2vec-base"},re.success("参数已重置"))}catch(e){re.error("加载参数配置失败")}},c=async()=>{if(i.value.chunkOverlap>=i.value.chunkSize)re.warning("分块重叠大小不能大于或等于分块大小");else{t.value=!0;try{await G(l.knowledgeBaseId,i.value),re.success("参数配置保存成功")}catch(e){re.error("保存参数配置失败："+(e.response?.data?.message||e.message))}finally{t.value=!1}}};return h(()=>{o()}),(e,a)=>{const l=u("el-icon"),p=u("el-input-number"),_=u("el-tooltip"),b=u("el-form-item"),y=u("el-input"),h=u("el-option"),w=u("el-select"),k=u("el-form"),C=u("el-button");return s(),d("div",da,[m("div",ca,[m("h3",pa,[r(l,null,{default:n(()=>[r(g(j))]),_:1}),a[4]||(a[4]=v(" 初始化策略默认值 "))]),m("div",va,[r(k,{"label-width":"120px"},{default:n(()=>[r(b,{label:"分块大小:"},{default:n(()=>[r(p,{modelValue:i.value.chunkSize,"onUpdate:modelValue":a[0]||(a[0]=e=>i.value.chunkSize=e),min:100,max:5e3,placeholder:"请输入分块大小"},null,8,["modelValue"]),r(_,{placement:"top",effect:"light"},{content:n(()=>a[5]||(a[5]=[m("div",{class:"tooltip-content"},[m("strong",null,"分块大小"),m("br"),v(" 文本分割时每个块的最大字符数。"),m("br"),v(" • 值太小：可能丢失上下文信息"),m("br"),v(" • 值太大：影响处理效率和准确性"),m("br"),m("em",null,"推荐值：500-1500")],-1)])),default:n(()=>[r(l,{class:"help-icon"},{default:n(()=>[r(g(f))]),_:1})]),_:1})]),_:1}),r(b,{label:"分块重叠:"},{default:n(()=>[r(p,{modelValue:i.value.chunkOverlap,"onUpdate:modelValue":a[1]||(a[1]=e=>i.value.chunkOverlap=e),min:0,max:1e3,placeholder:"请输入分块重叠大小"},null,8,["modelValue"]),r(_,{placement:"top",effect:"light"},{content:n(()=>a[6]||(a[6]=[m("div",{class:"tooltip-content"},[m("strong",null,"分块重叠"),m("br"),v(" 相邻文本块之间的重叠字符数。"),m("br"),v(" • 作用：保持上下文的连贯性"),m("br"),v(" • 通常设置为分块大小的10%-20%"),m("br"),m("em",null,"推荐值：50-300")],-1)])),default:n(()=>[r(l,{class:"help-icon"},{default:n(()=>[r(g(f))]),_:1})]),_:1})]),_:1}),r(b,{label:"分隔符:"},{default:n(()=>[r(y,{modelValue:i.value.separator,"onUpdate:modelValue":a[2]||(a[2]=e=>i.value.separator=e),placeholder:"例如：\\n\\n"},null,8,["modelValue"]),r(_,{placement:"top",effect:"light"},{content:n(()=>a[7]||(a[7]=[m("div",{class:"tooltip-content"},[m("strong",null,"分隔符"),m("br"),v(" 用于分割文本的字符或字符串。"),m("br"),v(" • \\n\\n：双换行（段落分割）"),m("br"),v(" • \\n：单换行"),m("br"),v(" • 。：句号"),m("br"),v(" • 自定义：根据文档结构设置"),m("br"),m("em",null,"默认：\\n\\n（段落分割）")],-1)])),default:n(()=>[r(l,{class:"help-icon"},{default:n(()=>[r(g(f))]),_:1})]),_:1})]),_:1}),r(b,{label:"嵌入模型:"},{default:n(()=>[r(w,{modelValue:i.value.embedding_model,"onUpdate:modelValue":a[3]||(a[3]=e=>i.value.embedding_model=e),placeholder:"选择模型",style:{width:"100%"}},{default:n(()=>[r(h,{label:"text2vec-base",value:"text2vec-base"}),r(h,{label:"text2vec-large",value:"text2vec-large"})]),_:1},8,["modelValue"]),r(_,{placement:"top",effect:"light"},{content:n(()=>a[8]||(a[8]=[m("div",{class:"tooltip-content"},[m("strong",null,"嵌入模型"),m("br"),v(" 将文本转换为向量表示的模型。"),m("br"),v(" • "),m("strong",null,"text2vec-base"),v("：基础版本，速度快"),m("br"),v(" • "),m("strong",null,"text2vec-large"),v("：增强版本，准确度高"),m("br"),m("em",null,"根据需求平衡速度与精度")],-1)])),default:n(()=>[r(l,{class:"help-icon"},{default:n(()=>[r(g(f))]),_:1})]),_:1})]),_:1})]),_:1}),m("div",ma,[m("div",ga,[r(l,null,{default:n(()=>[r(g(f))]),_:1}),a[9]||(a[9]=m("span",null,"参数配置说明",-1))]),a[10]||(a[10]=A('<div class="card-content" data-v-67493b9e><div class="param-item-desc" data-v-67493b9e><span class="param-name" data-v-67493b9e>分块策略：</span><span class="param-desc" data-v-67493b9e>合理的分块设置能显著提升检索准确性和效率</span></div><div class="param-item-desc" data-v-67493b9e><span class="param-name" data-v-67493b9e>模型选择：</span><span class="param-desc" data-v-67493b9e>根据数据量和精度要求选择合适的嵌入模型</span></div></div>',1))])])]),m("div",_a,[r(C,{type:"primary",onClick:c,loading:t.value},{loading:n(()=>[r(l,{class:"is-loading"},{default:n(()=>[r(g(x))]),_:1}),a[11]||(a[11]=v(" 保存中... "))]),default:n(()=>[a[12]||(a[12]=v(" 保存配置 "))]),_:1,__:[12]},8,["loading"]),r(C,{onClick:o},{default:n(()=>a[13]||(a[13]=[v("重置")])),_:1,__:[13]})])])}}},[["__scopeId","data-v-67493b9e"]]),ba={class:"evaluate-tab"},ya={class:"left-panel"},ha={class:"header"},wa={class:"right-panel"},ka={class:"detail-header"},Ca={key:0},Va={key:0,class:"warning"},Sa={key:1,class:"empty"},xa={class:"footer"},za=ne({__name:"EvaluateTab",setup(l){const t=e(),p=a(""),_=a(null),f=a([]),y=a(!1),V=a(!1),x=a({name:"",description:"",file:null}),z=a(!1),U=a([]),N=a(!1),O=S(()=>f.value.filter(e=>e.name.includes(p.value.trim()))),I=async()=>{try{const e=await X({knowledge_base_id:parseInt(t.params.id),page:1,size:10});f.value=(e.datasets||[]).map(e=>({id:e.id,name:e.name,description:e.description,date:e.created_at,questionCount:e.total_questions,status:e.status}))}catch(e){re.error("加载评测集失败")}},B=async e=>{try{const a=await Q(e.id);_.value={...e,metrics:a.metrics||{}}}catch(a){re.error("获取评测集详情失败")}},j=e=>{x.value.file=e.raw},A=async()=>{if(!x.value.name||!x.value.file)return re.warning("请填写名称并上传文件");try{const e=new FormData;e.append("name",x.value.name),e.append("knowledge_base_id",parseInt(t.params.id)),x.value.description&&e.append("description",x.value.description),e.append("file",x.value.file),await H(e),re.success("评测集创建成功"),V.value=!1,x.value={name:"",description:"",file:null},await I()}catch(e){re.error("创建失败")}},q=async()=>{if(_.value){y.value=!0;try{const e=await ee(_.value.id);_.value.metrics=e||{},re.success("评测完成")}catch(e){re.error("评测失败")}finally{y.value=!1}}},E=async()=>{if(_.value){z.value=!0,N.value=!0;try{const e=await ae(_.value.id);U.value=e.questions||[]}catch(e){re.error("加载问答失败")}finally{N.value=!1}}};return h(()=>I()),(e,a)=>{const l=u("el-icon"),t=u("el-input"),f=u("el-button"),h=u("el-table-column"),S=u("el-table"),R=u("el-descriptions-item"),D=u("el-descriptions"),F=u("el-form-item"),L=u("el-upload"),$=u("el-form"),P=u("el-dialog"),K=w("loading");return s(),d("div",ba,[m("div",ya,[m("div",ha,[r(t,{modelValue:p.value,"onUpdate:modelValue":a[0]||(a[0]=e=>p.value=e),placeholder:"搜索评测集",clearable:"",size:"small"},{prefix:n(()=>[r(l,null,{default:n(()=>[r(g(C))]),_:1})]),_:1},8,["modelValue"]),r(f,{type:"primary",size:"small",icon:"Plus",onClick:a[1]||(a[1]=e=>V.value=!0)},{default:n(()=>a[7]||(a[7]=[v(" 添加评测集 ")])),_:1,__:[7]})]),r(S,{data:O.value,border:"","highlight-current-row":"",onRowClick:B,class:"eval-table"},{default:n(()=>[r(h,{prop:"name",label:"评测集名称"}),r(h,{prop:"date",label:"日期",width:"120"}),r(h,{prop:"questionCount",label:"问题数",width:"100",align:"center"}),r(h,{label:"操作",width:"100",align:"center"},{default:n(e=>[r(f,{type:"danger",size:"small",text:"",onClick:T(a=>(async e=>{try{await oe.confirm(`确定要删除评测集「${e.name}」吗？`,"提示",{type:"warning"}),await W(e.id),re.success("删除成功"),_.value?.id===e.id&&(_.value=null),await I()}catch(a){"cancel"!==a&&re.error("删除失败")}})(e.row),["stop"])},{default:n(()=>a[8]||(a[8]=[v(" 删除 ")])),_:2,__:[8]},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),m("div",wa,[z.value&&_.value?(s(),d(c,{key:0},[m("div",ka,[r(f,{link:"",onClick:a[2]||(a[2]=e=>z.value=!1)},{default:n(()=>a[9]||(a[9]=[v("⬅ 返回")])),_:1,__:[9]}),m("h3",null,b(_.value.name)+" - 详情",1)]),r(D,{column:2,border:"",class:"mb-4"},{default:n(()=>[r(R,{label:"名称"},{default:n(()=>[v(b(_.value.name),1)]),_:1}),r(R,{label:"创建时间"},{default:n(()=>[v(b(_.value.date),1)]),_:1}),r(R,{label:"问题数"},{default:n(()=>[v(b(_.value.questionCount),1)]),_:1}),r(R,{label:"状态"},{default:n(()=>[v(b(_.value.status),1)]),_:1})]),_:1}),a[11]||(a[11]=m("h4",{class:"section-title"},"期望问答",-1)),k((s(),i(S,{data:U.value,border:"",style:{width:"100%"}},{default:n(()=>[r(h,{prop:"question",label:"问题","min-width":"180"}),r(h,{prop:"expected_answer",label:"期望回答","min-width":"180"}),r(h,{label:"操作",width:"100",align:"center"},{default:n(e=>[r(f,{type:"danger",size:"small",text:"",onClick:a=>(async e=>{try{await oe.confirm("确定要删除该问答吗？","提示",{type:"warning"}),await Z(_.value.id,e.id),re.success("删除成功"),U.value=U.value.filter(a=>a.id!==e.id)}catch(a){"cancel"!==a&&re.error("删除失败")}})(e.row)},{default:n(()=>a[10]||(a[10]=[v(" 删除 ")])),_:2,__:[10]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[K,N.value]])],64)):(s(),d(c,{key:1},[a[14]||(a[14]=m("h3",{class:"section-title"},"评估结果",-1)),_.value?(s(),d("div",Ca,[m("p",null,"当前评测集："+b(_.value.name),1),r(D,{column:1,border:""},{default:n(()=>[r(R,{label:"评测日期"},{default:n(()=>[v(b(_.value.metrics?.evaluation_date||"暂无"),1)]),_:1}),r(R,{label:"问题数"},{default:n(()=>[v(b(_.value.metrics?.total_questions??_.value.questionCount??0),1)]),_:1}),r(R,{label:"准确率"},{default:n(()=>[v(b(_.value.metrics?.accuracy??0)+"% ",1)]),_:1}),r(R,{label:"召回率"},{default:n(()=>[v(b(_.value.metrics?.recall??0)+"% ",1)]),_:1}),r(R,{label:"响应时间"},{default:n(()=>[v(b(_.value.metrics?.response_time??0)+" ms ",1)]),_:1}),r(R,{label:"合理性得分"},{default:n(()=>[v(b(_.value.metrics?.reasonableness??0)+"% ",1)]),_:1}),r(R,{label:"覆盖率"},{default:n(()=>[v(b(_.value.metrics?.coverage??0)+"% ",1)]),_:1}),r(R,{label:"成功率"},{default:n(()=>[v(b(_.value.metrics?.success_rate??0)+"% ",1)]),_:1}),r(R,{label:"总体得分"},{default:n(()=>[v(b(_.value.metrics?.overall_score??0),1)]),_:1})]),_:1}),(_.value.metrics?.coverage??0)<90?(s(),d("div",Va," ⚠️ 覆盖率低于 90%，请检查未覆盖的问题 ")):o("",!0)])):(s(),d("div",Sa," 请选择左侧的评测集以查看评估结果 ")),m("div",xa,[r(f,{type:"primary",loading:y.value,onClick:q},{default:n(()=>a[12]||(a[12]=[v(" 运行评估 ")])),_:1,__:[12]},8,["loading"]),_.value?(s(),i(f,{key:0,type:"success",onClick:E},{default:n(()=>a[13]||(a[13]=[v(" 查看详情 ")])),_:1,__:[13]})):o("",!0)])],64))]),r(P,{title:"添加评测集",modelValue:V.value,"onUpdate:modelValue":a[6]||(a[6]=e=>V.value=e),width:"500px"},{footer:n(()=>[r(f,{onClick:a[5]||(a[5]=e=>V.value=!1)},{default:n(()=>a[16]||(a[16]=[v("取消")])),_:1,__:[16]}),r(f,{type:"primary",onClick:A},{default:n(()=>a[17]||(a[17]=[v("确定")])),_:1,__:[17]})]),default:n(()=>[r($,{model:x.value,"label-width":"100px"},{default:n(()=>[r(F,{label:"名称",required:""},{default:n(()=>[r(t,{modelValue:x.value.name,"onUpdate:modelValue":a[3]||(a[3]=e=>x.value.name=e),placeholder:"请输入名称"},null,8,["modelValue"])]),_:1}),r(F,{label:"描述"},{default:n(()=>[r(t,{modelValue:x.value.description,"onUpdate:modelValue":a[4]||(a[4]=e=>x.value.description=e),placeholder:"请输入描述"},null,8,["modelValue"])]),_:1}),r(F,{label:"上传文件",required:""},{default:n(()=>[r(L,{drag:"","auto-upload":!1,limit:1,accept:".json","on-change":j},{default:n(()=>a[15]||(a[15]=[m("i",{class:"el-icon-upload"},null,-1),m("div",{class:"el-upload__text"},[v(" 将文件拖到此处，或 "),m("em",null,"点击上传")],-1)])),_:1,__:[15]})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},[["__scopeId","data-v-b211a0db"]]),Ua={class:"optimize-tab"},Na={class:"filter-bar"},Oa={class:"action-bar",style:{margin:"15px 0"}},Ia={style:{"margin-top":"20px","text-align":"right"}},Ba=ne({__name:"OptimizeTab",setup(l){const t=a(!1),o=a([]),c=a([]),p=e().params.id,g=a({target:"all",status:"all",keyword:""}),_=a({page:1,pageSize:10,total:0}),f=async()=>{t.value=!0;try{const e={target:"all"===g.value.target?void 0:g.value.target,status:"all"===g.value.status?void 0:g.value.status,keyword:g.value.keyword||void 0,page:_.value.page,pageSize:_.value.pageSize},a=await le(p,e);o.value=a.list||[],_.value.total=a.total||0}catch(e){re.error("获取调优建议失败")}finally{t.value=!1}},b=()=>{g.value={target:"all",status:"all",keyword:""},_.value.page=1,f()},y=e=>{c.value=e},h=async()=>{const e=c.value.map(e=>e.id);if(!e.length)return re.warning("请选择数据");try{await ie(p,e),c.value.forEach(e=>e.status="applied"),re.success("批量应用成功")}catch{re.error("操作失败")}},C=async()=>{const e=c.value.map(e=>e.id);if(!e.length)return re.warning("请选择数据");try{await se(p,e),c.value.forEach(e=>e.status="ignored"),re.success("批量忽略成功")}catch{re.error("操作失败")}};return f(),(e,a)=>{const l=u("el-option"),c=u("el-select"),V=u("el-input"),S=u("el-button"),x=u("el-table-column"),z=u("el-tag"),U=u("el-table"),N=u("el-pagination"),O=w("loading");return s(),d("div",Ua,[m("div",Na,[r(c,{modelValue:g.value.target,"onUpdate:modelValue":a[0]||(a[0]=e=>g.value.target=e),placeholder:"调优对象",clearable:"",style:{width:"160px","margin-right":"10px"}},{default:n(()=>[r(l,{label:"全部",value:"all"}),r(l,{label:"初始化策略",value:"init"}),r(l,{label:"检索策略",value:"retrieval"})]),_:1},8,["modelValue"]),r(c,{modelValue:g.value.status,"onUpdate:modelValue":a[1]||(a[1]=e=>g.value.status=e),placeholder:"状态",clearable:"",style:{width:"140px","margin-right":"10px"}},{default:n(()=>[r(l,{label:"全部",value:"all"}),r(l,{label:"未处理",value:"pending"}),r(l,{label:"已应用",value:"applied"}),r(l,{label:"已忽略",value:"ignored"})]),_:1},8,["modelValue"]),r(V,{modelValue:g.value.keyword,"onUpdate:modelValue":a[2]||(a[2]=e=>g.value.keyword=e),placeholder:"请输入关键词或问题内容",clearable:"",style:{width:"260px","margin-right":"10px"}},null,8,["modelValue"]),r(S,{type:"primary",onClick:f},{default:n(()=>a[5]||(a[5]=[v("查询")])),_:1,__:[5]}),r(S,{onClick:b},{default:n(()=>a[6]||(a[6]=[v("重置")])),_:1,__:[6]})]),m("div",Oa,[r(S,{type:"success",onClick:f},{default:n(()=>a[7]||(a[7]=[v("刷新建议")])),_:1,__:[7]}),r(S,{type:"primary",onClick:h},{default:n(()=>a[8]||(a[8]=[v("批量应用")])),_:1,__:[8]}),r(S,{type:"danger",onClick:C},{default:n(()=>a[9]||(a[9]=[v("批量忽略")])),_:1,__:[9]})]),k((s(),i(U,{data:o.value,border:"",style:{width:"100%"},onSelectionChange:y},{default:n(()=>[r(x,{type:"selection",width:"55"}),r(x,{prop:"target",label:"调优对象",width:"120"}),r(x,{prop:"type",label:"策略类型",width:"160"}),r(x,{prop:"analysis",label:"分析依据"}),r(x,{prop:"suggestion",label:"系统建议"}),r(x,{prop:"time",label:"建议时间",width:"160"}),r(x,{prop:"status",label:"状态",width:"100"},{default:n(({row:e})=>["pending"===e.status?(s(),i(z,{key:0,type:"warning"},{default:n(()=>a[10]||(a[10]=[v("未处理")])),_:1,__:[10]})):"applied"===e.status?(s(),i(z,{key:1,type:"success"},{default:n(()=>a[11]||(a[11]=[v("已应用")])),_:1,__:[11]})):(s(),i(z,{key:2,type:"info"},{default:n(()=>a[12]||(a[12]=[v("已忽略")])),_:1,__:[12]}))]),_:1}),r(x,{label:"操作",width:"180"},{default:n(({row:e})=>[r(S,{size:"small",type:"primary",onClick:a=>(async e=>{try{await te(p,e.id),e.status="applied",re.success("已应用")}catch{re.error("操作失败")}})(e)},{default:n(()=>a[13]||(a[13]=[v("应用")])),_:2,__:[13]},1032,["onClick"]),r(S,{size:"small",type:"danger",onClick:a=>(async e=>{try{await ue(p,e.id),e.status="ignored",re.success("已忽略")}catch{re.error("操作失败")}})(e)},{default:n(()=>a[14]||(a[14]=[v("忽略")])),_:2,__:[14]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[O,t.value]]),m("div",Ia,[r(N,{"current-page":_.value.page,"onUpdate:currentPage":a[3]||(a[3]=e=>_.value.page=e),"page-size":_.value.pageSize,"onUpdate:pageSize":a[4]||(a[4]=e=>_.value.pageSize=e),total:_.value.total,background:"",layout:"prev, pager, next, jumper",onCurrentChange:f},null,8,["current-page","page-size","total"])])])}}},[["__scopeId","data-v-243bb5ce"]]),ja={class:"knowledge-base-page"},Aa={class:"header-bar"},Ta={class:"kb_name"},qa=ne({__name:"KnowledgeBase",setup(t){const o=a("data-source"),v=q(),_=e(),f=F(),y=S(()=>f.currentKB?.name||"未知知识库");function w(){v.push("/knowledgelist")}const k=S(()=>{const e=f.userRole;return 1===e||2===e||3===e}),C=S(()=>{const e=[{label:"数据源",name:"data-source"}];return k.value&&e.push({label:"权限",name:"permission"},{label:"参数",name:"param"},{label:"评测",name:"evaluate"},{label:"调优",name:"optimize"},{label:"日志",name:"log"}),e}),V={"data-source":Ne,permission:ua,param:fa,evaluate:za,optimize:Ba,log:oa};return l(o,e=>{C.value.some(a=>a.name===e)||(o.value="data-source",re.warning("您没有权限访问该页面"))},{immediate:!0}),h(()=>{const e=_.params.id;if(e&&!f.currentKB){const a=f.getKBById(e);a?f.setCurrentKB(a):re.warning("未找到对应的知识库信息")}const a=_.query.tab;a&&C.value.some(e=>e.name===a)&&(o.value=a)}),(e,a)=>{const l=u("el-icon"),t=u("el-tab-pane"),v=u("el-tabs");return s(),d("div",ja,[m("div",Aa,[m("div",{class:"back",onClick:w},[r(l,null,{default:n(()=>[r(g(E))]),_:1}),a[1]||(a[1]=m("span",{class:"back-text"},"知识库总页",-1))]),r(v,{modelValue:o.value,"onUpdate:modelValue":a[0]||(a[0]=e=>o.value=e),class:"custom-tabs",stretch:"","tab-position":"top"},{default:n(()=>[(s(!0),d(c,null,p(C.value,e=>(s(),i(t,{key:e.name,label:e.label,name:e.name},null,8,["label","name"]))),128))]),_:1},8,["modelValue"])]),m("div",Ta," 🟢 当前知识库："+b(y.value),1),(s(),i(R(V[o.value]),{"knowledge-base-id":g(_).params.id},null,8,["knowledge-base-id"]))])}}},[["__scopeId","data-v-ee3b7145"]]);export{qa as default};
